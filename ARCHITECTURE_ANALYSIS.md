# Детальная карта трансформации PPEE-Flask в систему "Помощников"

## Текущая архитектура (PPEE-Flask)

**Концепция:** Система анализа документов ППЭЭ с помощью LLM
- **Application** - заявка для обработки документов
- **Checklist** - чек-лист параметров для извлечения из документов
- **ChecklistParameter** - конкретный параметр для поиска в документах
- **User** - пользователи с ролями (admin, prompt_engineer, user)

## Новая архитектура (Система Помощников)

**Концепция:** Универсальная платформа для создания и использования LLM-помощников
- **Assistant** - конфигурируемый помощник (бывший Application)
- **PromptTemplate** - шаблон промпта для помощника (бывший Checklist)
- **PromptParameter** - параметр шаблона (бывший ChecklistParameter)
- **User** - пользователи с ролями (admin, template_creator, user)

## 🏗️ Архитектура системы

### Основные компоненты:

```
┌─────────────────────────────────────────────────────────────┐
│                     Web UI (Flask)                          │
│  ┌────────────┐  ┌────────────┐  ┌─────────────────────┐   │
│  │ Blueprints │  │  Templates │  │  Static (CSS/JS)    │   │
│  └────────────┘  └────────────┘  └─────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                   Business Logic Layer                      │
│  ┌────────────┐  ┌────────────┐  ┌─────────────────────┐   │
│  │   Models   │  │  Services  │  │      Tasks          │   │
│  └────────────┘  └────────────┘  └─────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                     Data & Services                         │
│  ┌──────────┐  ┌─────────┐  ┌─────────┐  ┌──────────────┐  │
│  │   SQLite │  │  Redis  │  │ Qdrant  │  │ FastAPI      │  │
│  │    DB    │  │  Broker │  │ Vector  │  │ Service      │  │
│  └──────────┘  └─────────┘  └─────────┘  └──────────────┘  │
└─────────────────────────────────────────────────────────────┘
                                               │
                                               ▼
                              ┌──────────────────────────────┐
                              │        Ollama LLM            │
                              └──────────────────────────────┘
```

## 📊 Модели данных

### 1. **User** (Пользователи)
- **Роли**: admin, prompt_engineer, user
- **Функции**: 
  - Аутентификация через Flask-Login
  - Управление правами доступа
  - Владение заявками и чек-листами

### 2. **Application** (Заявки)
- **Назначение**: Контейнер для анализируемых документов
- **Статусы**: created → indexing → indexed → analyzing → analyzed / error
- **Связи**:
  - Может содержать множество файлов (Files)
  - Привязана к одному или нескольким чек-листам
  - Содержит результаты анализа (ParameterResults)

### 3. **File** (Файлы)
- **Назначение**: Хранение информации о загруженных PDF документах
- **Отслеживание**:
  - Статус индексации (pending, indexing, completed, error)
  - Количество чанков после обработки
  - Время индексации

### 4. **Checklist** (Чек-листы)
- **Назначение**: Шаблоны для анализа документов
- **Особенности**:
  - Может быть публичным или приватным
  - Содержит упорядоченный список параметров
  - Привязан к владельцу (User)

### 5. **ChecklistParameter** (Параметры чек-листа)
- **Назначение**: Определение того, что нужно найти в документе
- **Настройки**:
  - `search_query` - запрос для векторного поиска
  - `llm_query` - запрос для LLM (опционально)
  - Конфигурация LLM (модель, промпт, температура)
  - Настройки поиска (лимиты, ре-ранкинг)

### 6. **ParameterResult** (Результаты анализа)
- **Назначение**: Хранение найденных значений параметров
- **Содержит**:
  - Найденное значение
  - Уровень уверенности
  - Результаты поиска (чанки документа)
  - Детали запроса к LLM

## 🔄 Основные процессы (Workflow)

### 1. **Создание заявки**
```
Пользователь → Создает заявку → Выбирает чек-листы → Загружает PDF файлы
```

### 2. **Индексация документов**
```
PDF файл → FastAPI сервис → Разбивка на чанки → 
→ Векторизация → Сохранение в Qdrant
```

**Процесс индексации:**
- Файл отправляется в FastAPI сервис
- FastAPI разбивает PDF на чанки (семантические или фиксированные)
- Каждый чанк векторизуется с помощью модели эмбеддингов
- Векторы сохраняются в Qdrant с метаданными

### 3. **Анализ документов (3-х этапный)**

**Этап 1: Векторный поиск**
```python
Для каждого параметра:
  → Векторный поиск по search_query
  → Опционально: ре-ранкинг результатов
  → Получение топ-N релевантных чанков
```

**Этап 2: Обработка через LLM**
```python
Если найдены релевантные чанки:
  → Формирование контекста из чанков
  → Генерация промпта с контекстом
  → Запрос к LLM для извлечения значения
  → Сохранение результата
```

**Этап 3: Полное сканирование (опционально)**
```python
Для параметров без результата и с use_full_scan=True:
  → Загрузка ВСЕХ чанков документа
  → Группировка чанков пакетами по размеру
  → Обработка каждого пакета через LLM
  → Остановка при нахождении значения
```

## 🔧 Технические особенности

### Асинхронная обработка (Celery)
- **Задачи**:
  - `index_document_task` - индексация документов
  - `process_parameters_task` - анализ по чек-листам
  - `semantic_search_task` - семантический поиск

- **Особенности**:
  - Отслеживание прогресса в реальном времени
  - Возможность отмены задач
  - Обработка ошибок с сохранением частичных результатов

### Векторный поиск (Qdrant)
- **Коллекция**: `ppee_applications` (настраивается)
- **Фильтрация**: по application_id
- **Методы поиска**:
  - Векторный (по эмбеддингам)
  - Гибридный (векторный + текстовый)
  - С ре-ранкингом для повышения точности

### Интеграция с LLM (Ollama)
- **Модели**: Локальные LLM через Ollama
- **Настройки**:
  - Кастомные промпты для каждого параметра
  - Контроль температуры и токенов
  - Обработка пакетами для больших объемов

## 🔌 Внешние сервисы

### 1. **FastAPI Service** (порт 8001/8002)
**Функции**:
- Индексация документов
- Векторный поиск
- Взаимодействие с LLM
- Управление чанками в Qdrant

**API endpoints**:
- `POST /index` - индексация документа
- `POST /search` - векторный поиск
- `POST /llm/process` - обработка через LLM
- `GET /applications/{id}/stats` - статистика
- `DELETE /applications/{id}` - удаление данных

### 2. **Qdrant** (порт 6333)
- Векторная база данных
- Хранение эмбеддингов чанков
- Семантический поиск

### 3. **Redis** (порт 6379)
- Брокер сообщений для Celery
- Хранение результатов задач

### 4. **Ollama** (порт 11434)
- Локальный сервер LLM
- Поддержка различных моделей
- API для генерации текста

## 🔐 Безопасность и права доступа

### Роли пользователей:
1. **admin** - полный доступ
2. **prompt_engineer** - управление чек-листами и промптами
3. **user** - создание заявок и просмотр результатов

### Декораторы доступа:
- `@login_required` - требует аутентификации
- `@admin_required` - только для админов
- `@prompt_engineer_required` - для инженеров промптов

## 📁 Структура проекта

```
ppee-flask/
├── app/
│   ├── __init__.py           # Фабрика приложения
│   ├── models/               # Модели данных
│   │   ├── user.py
│   │   ├── application.py
│   │   └── checklist.py
│   ├── blueprints/           # Модули Flask
│   │   ├── applications/    # Управление заявками
│   │   ├── checklists/      # Управление чек-листами
│   │   ├── auth/            # Аутентификация
│   │   ├── llm_management/  # Управление LLM
│   │   ├── search/          # Поисковый интерфейс
│   │   ├── stats/           # Статистика
│   │   └── users/           # Управление пользователями
│   ├── tasks/               # Асинхронные задачи Celery
│   │   ├── indexing_tasks.py
│   │   ├── llm_tasks.py
│   │   └── search_tasks.py
│   ├── services/            # Сервисы
│   │   └── fastapi_client.py
│   ├── utils/               # Утилиты
│   │   ├── chunk_utils.py
│   │   ├── db_utils.py
│   │   └── pdf_generator.py
│   └── templates/           # HTML шаблоны
├── config.py               # Конфигурация
├── wsgi.py                # Точка входа WSGI
├── celery_worker.py       # Воркер Celery
└── initialize_db.py       # Инициализация БД
```

## 💡 Ключевые особенности для переиспользования

1. **Модульная архитектура** - легко добавлять новые blueprints
2. **Гибкая система чек-листов** - настраиваемые параметры поиска
3. **Асинхронная обработка** - масштабируемость через Celery
4. **Векторный поиск** - семантическое понимание контекста
5. **Интеграция с LLM** - извлечение структурированных данных
6. **Прогресс в реальном времени** - отслеживание выполнения
7. **Система ролей** - гибкое управление доступом

## 🚀 Возможности для улучшения

1. **Масштабирование**:
   - Переход на PostgreSQL для production
   - Kubernetes для оркестрации
   - Распределенная обработка

2. **Функциональность**:
   - Поддержка других форматов (Word, Excel)
   - API для внешних интеграций
   - Batch-обработка заявок

3. **UX/UI**:
   - WebSocket для real-time обновлений
   - Визуализация результатов
   - Экспорт в различные форматы

## 📝 Выводы

Проект представляет собой хорошо структурированное Flask-приложение с четким разделением ответственности, асинхронной обработкой задач и интеграцией с современными ML-технологиями. Архитектура позволяет легко адаптировать систему под другие задачи анализа документов путем изменения чек-листов и промптов.