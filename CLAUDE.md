# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Описание проекта

PPEE-Flask - это веб-приложение для обработки и анализа документов ППЭЭ (программа производственного экологического контроля) с использованием технологий машинного обучения. Система позволяет загружать PDF документы, индексировать их в векторной базе данных и выполнять семантический поиск с помощью LLM.

## Архитектура системы

### Основные компоненты:

1. **Flask приложение** (`ppee-flask/`) - основное веб-приложение
   - Blueprints для модульной организации: applications, checklists, auth, llm_management, search, stats, users
   - SQLAlchemy для работы с БД
   - Flask-Login для аутентификации

2. **Celery** - асинхронная обработка задач
   - Индексирование документов
   - Обработка LLM запросов
   - Семантический поиск

3. **Внешние сервисы**:
   - **Qdrant** - векторная база данных для семантического поиска
   - **Redis** - брокер сообщений для Celery
   - **Ollama** - локальный LLM сервер
   - **FastAPI сервис** - дополнительный API для обработки данных

## Команды разработки

### Запуск приложения
```bash
# Основное Flask приложение
cd ppee-flask
python wsgi.py

# Celery worker для асинхронных задач
celery -A celery_worker.celery worker --loglevel=info

# Flower для мониторинга Celery (опционально)
celery -A celery_worker.celery flower
```

### Инициализация базы данных
```bash
cd ppee-flask
python initialize_db.py  # Создает таблицы и тестовые данные
```

### Миграции базы данных
```bash
cd ppee-flask
flask db init      # Инициализация миграций (если еще не создано)
flask db migrate -m "описание изменений"  # Создание новой миграции
flask db upgrade    # Применение миграций
```

### Требования к окружению

Перед запуском убедитесь, что запущены:
- Redis сервер (порт 6379)
- Qdrant (порт 6333)
- Ollama с загруженной моделью (по умолчанию gemma3:27b)
- FastAPI сервис (порт 8001) - если используется

### Переменные окружения

Основные переменные в `.env`:
- `QDRANT_HOST` - хост Qdrant (по умолчанию localhost)
- `QDRANT_PORT` - порт Qdrant (по умолчанию 6333)
- `DEVICE` - устройство для ML моделей (cuda/cpu)
- `SECRET_KEY` - секретный ключ Flask (обязательно для production)
- `DATABASE_URL` - URL базы данных (по умолчанию sqlite)

## Структура кода

### Модели данных (`app/models/`)
- `User` - пользователи системы с ролями (admin, prompt_engineer, user)
- `Application` - заявки/документы для обработки
- `Checklist` - чек-листы с параметрами для анализа документов
- `ChecklistParameter` - параметры чек-листа с настройками LLM

### Задачи Celery (`app/tasks/`)
- `BaseTask` - базовый класс с обработкой прогресса и ошибок
- `indexing_tasks` - индексирование документов в Qdrant
- `llm_tasks` - обработка запросов к LLM
- `search_tasks` - семантический поиск по документам

### Blueprints (`app/blueprints/`)
Каждый blueprint содержит routes.py с маршрутами и логикой:
- `applications` - управление документами и заявками
- `checklists` - создание и управление чек-листами
- `llm_management` - настройки и тестирование LLM
- `search` - поисковый интерфейс
- `auth` - аутентификация и авторизация
- `users` - управление пользователями

## Работа с LLM

Система использует Ollama для работы с локальными LLM моделями. Промпты настраиваются в чек-листах для каждого параметра. По умолчанию используется модель `gemma3:27b-it-qat`.

Для добавления новой модели:
1. Загрузите модель в Ollama: `ollama pull model_name`
2. Укажите имя модели в настройках чек-листа или в `DEFAULT_LLM_MODEL`

## Семантический поиск

Система поддерживает два режима чанкинга документов:
- Семантический (USE_SEMANTIC_CHUNKING=1) - разбивка по смыслу
- Фиксированный - разбивка по количеству символов

Поиск выполняется через Qdrant с использованием векторных представлений текста.