{% extends "base.html" %}

{% block content %}
    <div class="page-header">
        <h1>
            <span id="assistant-name-display">{{ application.name }}</span>
            {% if current_user.id == application.user_id or current_user.is_admin() %}
            <button id="edit-name-btn" class="edit-btn" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –Ω–∞–∑–≤–∞–Ω–∏–µ">
                <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                    <path d="M12.146.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1 0 .708l-10 10a.5.5 0 0 1-.168.11l-5 2a.5.5 0 0 1-.65-.65l2-5a.5.5 0 0 1 .11-.168l10-10zM11.207 2.5L13.5 4.793 14.793 3.5 12.5 1.207 11.207 2.5zm1.586 3L10.5 3.207 4 9.707V10h.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.5h.293l6.5-6.5zm-9.761 5.175l-.106.106-1.528 3.821 3.821-1.528.106-.106A.5.5 0 0 1 5 12.5V12h-.5a.5.5 0 0 1-.5-.5V11h-.5a.5.5 0 0 1-.468-.325z"/>
                </svg>
            </button>
            {% endif %}
        </h1>
        <div class="button-group">
            <a href="{{ url_for('applications.index') }}" class="button button-secondary">‚Üê –ö —Å–ø–∏—Å–∫—É</a>
            <a id="open-chat-btn" href="{{ url_for('chat.chat_with_assistant', assistant_id=application.id) }}" class="button button-primary">üí¨ –û—Ç–∫—Ä—ã—Ç—å —á–∞—Ç</a>
        </div>
    </div>

    <!-- –§–æ—Ä–º–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –Ω–∞–∑–≤–∞–Ω–∏—è -->
    {% if current_user.id == application.user_id or current_user.is_admin() %}
    <div id="edit-name-form" class="edit-form" style="display: none;">
        <form method="post" action="{{ url_for('applications.edit', id=application.id) }}" class="inline-edit-form">
            <input type="text" name="name" id="name-input" value="{{ application.name }}" required>
            <input type="hidden" name="description" value="{{ application.description or '' }}">
            <button type="submit" class="button button-small">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            <button type="button" class="button button-small button-secondary" onclick="cancelEditName()">–û—Ç–º–µ–Ω–∞</button>
        </form>
    </div>
    {% endif %}

    <!-- –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–º–æ—â–Ω–∏–∫–µ -->
    <div class="assistant-details">
        <div class="info-card">
            <h2>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–º–æ—â–Ω–∏–∫–µ</h2>

            <div class="info-row">
                <div class="info-label">
                    –¢–∏–ø –ø–æ–º–æ—â–Ω–∏–∫–∞:
                    {% if current_user.id == application.user_id or current_user.is_admin() %}
                    <button class="edit-btn" onclick="editField('assistant_type')" title="–ò–∑–º–µ–Ω–∏—Ç—å —Ç–∏–ø">
                        <svg width="14" height="14" viewBox="0 0 16 16" fill="currentColor">
                            <path d="M12.146.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1 0 .708l-10 10a.5.5 0 0 1-.168.11l-5 2a.5.5 0 0 1-.65-.65l2-5a.5.5 0 0 1 .11-.168l10-10zM11.207 2.5L13.5 4.793 14.793 3.5 12.5 1.207 11.207 2.5zm1.586 3L10.5 3.207 4 9.707V10h.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.5h.293l6.5-6.5zm-9.761 5.175l-.106.106-1.528 3.821 3.821-1.528.106-.106A.5.5 0 0 1 5 12.5V12h-.5a.5.5 0 0 1-.5-.5V11h-.5a.5.5 0 0 1-.468-.325z"/>
                        </svg>
                    </button>
                    {% endif %}
                </div>
                <div class="info-value">
                    {% set type_names = {
                        'support': 'üÜò –¢–µ—Ö–ø–æ–¥–¥–µ—Ä–∂–∫–∞',
                        'knowledge': 'üìö –ë–∞–∑–∞ –∑–Ω–∞–Ω–∏–π',
                        'assistant': 'ü§ñ –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç',
                        'custom': '‚öôÔ∏è –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π'
                    } %}
                    <div id="assistant_type-display">{{ type_names.get(application.assistant_type or 'support', 'üÜò –¢–µ—Ö–ø–æ–¥–¥–µ—Ä–∂–∫–∞') }}</div>
                    {% if current_user.id == application.user_id or current_user.is_admin() %}
                    <div id="assistant_type-edit" class="edit-form" style="display: none;">
                        <form method="post" action="{{ url_for('applications.update_settings', id=application.id) }}" class="inline-edit-form">
                            <select name="assistant_type" id="assistant_type-input">
                                <option value="support" {% if application.assistant_type == 'support' %}selected{% endif %}>üÜò –¢–µ—Ö–ø–æ–¥–¥–µ—Ä–∂–∫–∞</option>
                                <option value="knowledge" {% if application.assistant_type == 'knowledge' %}selected{% endif %}>üìö –ë–∞–∑–∞ –∑–Ω–∞–Ω–∏–π</option>
                                <option value="assistant" {% if application.assistant_type == 'assistant' %}selected{% endif %}>ü§ñ –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç</option>
                                <option value="custom" {% if application.assistant_type == 'custom' %}selected{% endif %}>‚öôÔ∏è –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π</option>
                            </select>
                            <button type="submit" class="button button-small">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                            <button type="button" class="button button-small button-secondary" onclick="cancelEdit('assistant_type')">–û—Ç–º–µ–Ω–∞</button>
                        </form>
                    </div>
                    {% endif %}
                </div>
            </div>

            <div class="info-row">
                <div class="info-label">
                    –û–ø–∏—Å–∞–Ω–∏–µ:
                    {% if current_user.id == application.user_id or current_user.is_admin() %}
                    <button id="edit-description-btn" class="edit-btn" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –æ–ø–∏—Å–∞–Ω–∏–µ">
                        <svg width="14" height="14" viewBox="0 0 16 16" fill="currentColor">
                            <path d="M12.146.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1 0 .708l-10 10a.5.5 0 0 1-.168.11l-5 2a.5.5 0 0 1-.65-.65l2-5a.5.5 0 0 1 .11-.168l10-10zM11.207 2.5L13.5 4.793 14.793 3.5 12.5 1.207 11.207 2.5zm1.586 3L10.5 3.207 4 9.707V10h.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.5h.293l6.5-6.5zm-9.761 5.175l-.106.106-1.528 3.821 3.821-1.528.106-.106A.5.5 0 0 1 5 12.5V12h-.5a.5.5 0 0 1-.5-.5V11h-.5a.5.5 0 0 1-.468-.325z"/>
                        </svg>
                    </button>
                    {% endif %}
                </div>
                <div class="info-value">
                    <div id="description-display">{{ application.description or '–ù–µ—Ç –æ–ø–∏—Å–∞–Ω–∏—è' }}</div>
                    {% if current_user.id == application.user_id or current_user.is_admin() %}
                    <div id="edit-description-form" class="edit-form" style="display: none;">
                        <form method="post" action="{{ url_for('applications.edit', id=application.id) }}">
                            <input type="hidden" name="name" value="{{ application.name }}">
                            <textarea name="description" id="description-input" rows="3">{{ application.description or '' }}</textarea>
                            <div class="form-actions">
                                <button type="submit" class="button button-small">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                                <button type="button" class="button button-small button-secondary" onclick="cancelEditDescription()">–û—Ç–º–µ–Ω–∞</button>
                            </div>
                        </form>
                    </div>
                    {% endif %}
                </div>
            </div>

            <div class="info-row">
                <div class="info-label">–í–ª–∞–¥–µ–ª–µ—Ü:</div>
                <div class="info-value">
                    {% if application.user %}
                        {% if application.user.id == current_user.id %}
                            <strong>–í—ã</strong>
                        {% else %}
                            {{ application.user.username }}
                        {% endif %}
                    {% else %}
                        <span class="text-muted">–°–∏—Å—Ç–µ–º–Ω—ã–π</span>
                    {% endif %}
                </div>
            </div>

            <div class="info-row">
                <div class="info-label">
                    –î–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å:
                    {% if current_user.id == application.user_id or current_user.is_admin() %}
                    <button class="edit-btn" onclick="editField('is_public')" title="–ò–∑–º–µ–Ω–∏—Ç—å –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å">
                        <svg width="14" height="14" viewBox="0 0 16 16" fill="currentColor">
                            <path d="M12.146.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1 0 .708l-10 10a.5.5 0 0 1-.168.11l-5 2a.5.5 0 0 1-.65-.65l2-5a.5.5 0 0 1 .11-.168l10-10zM11.207 2.5L13.5 4.793 14.793 3.5 12.5 1.207 11.207 2.5zm1.586 3L10.5 3.207 4 9.707V10h.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.5h.293l6.5-6.5zm-9.761 5.175l-.106.106-1.528 3.821 3.821-1.528.106-.106A.5.5 0 0 1 5 12.5V12h-.5a.5.5 0 0 1-.5-.5V11h-.5a.5.5 0 0 1-.468-.325z"/>
                        </svg>
                    </button>
                    {% endif %}
                </div>
                <div class="info-value">
                    <div id="is_public-display">
                        {% if application.is_public %}
                            <span class="badge badge-success">üåç –ü—É–±–ª–∏—á–Ω—ã–π</span>
                        {% else %}
                            <span class="badge badge-secondary">üîí –ü—Ä–∏–≤–∞—Ç–Ω—ã–π</span>
                        {% endif %}
                    </div>
                    {% if current_user.id == application.user_id or current_user.is_admin() %}
                    <div id="is_public-edit" class="edit-form" style="display: none;">
                        <form method="post" action="{{ url_for('applications.update_settings', id=application.id) }}" class="inline-edit-form">
                            <div class="checkbox-item">
                                <input type="checkbox" name="is_public" id="is_public-input" 
                                       {% if application.is_public %}checked{% endif %}>
                                <label for="is_public-input">–°–¥–µ–ª–∞—Ç—å –ø–æ–º–æ—â–Ω–∏–∫–∞ –ø—É–±–ª–∏—á–Ω—ã–º</label>
                            </div>
                            <button type="submit" class="button button-small">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                            <button type="button" class="button button-small button-secondary" onclick="cancelEdit('is_public')">–û—Ç–º–µ–Ω–∞</button>
                        </form>
                    </div>
                    {% endif %}
                </div>
            </div>

            <div class="info-row">
                <div class="info-label">
                    –ú–æ–¥–µ–ª—å LLM:
                    {% if current_user.id == application.user_id or current_user.is_admin() %}
                    <button class="edit-btn" onclick="editField('llm_model')" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –º–æ–¥–µ–ª—å">
                        <svg width="14" height="14" viewBox="0 0 16 16" fill="currentColor">
                            <path d="M12.146.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1 0 .708l-10 10a.5.5 0 0 1-.168.11l-5 2a.5.5 0 0 1-.65-.65l2-5a.5.5 0 0 1 .11-.168l10-10zM11.207 2.5L13.5 4.793 14.793 3.5 12.5 1.207 11.207 2.5zm1.586 3L10.5 3.207 4 9.707V10h.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.5h.293l6.5-6.5zm-9.761 5.175l-.106.106-1.528 3.821 3.821-1.528.106-.106A.5.5 0 0 1 5 12.5V12h-.5a.5.5 0 0 1-.5-.5V11h-.5a.5.5 0 0 1-.468-.325z"/>
                        </svg>
                    </button>
                    {% endif %}
                </div>
                <div class="info-value">
                    <div id="llm_model-display">{{ application.llm_model or 'gemma3:27b' }}</div>
                    {% if current_user.id == application.user_id or current_user.is_admin() %}
                    <div id="llm_model-edit" class="edit-form" style="display: none;">
                        <form method="post" action="{{ url_for('applications.update_settings', id=application.id) }}" class="inline-edit-form">
                            <select name="llm_model" id="llm_model-input">
                                {% for model in available_models %}
                                    <option value="{{ model }}" {% if model == (application.llm_model or 'gemma3:27b') %}selected{% endif %}>{{ model }}</option>
                                {% endfor %}
                            </select>
                            <button type="submit" class="button button-small">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                            <button type="button" class="button button-small button-secondary" onclick="cancelEdit('llm_model')">–û—Ç–º–µ–Ω–∞</button>
                        </form>
                    </div>
                    {% endif %}
                </div>
            </div>

            <div class="info-row">
                <div class="info-label">–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è:</div>
                <div class="info-value">{{ application.created_at|to_moscow_time|strftime('%d.%m.%Y %H:%M') }} –ú–°–ö</div>
            </div>
        </div>

        <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è -->
        <div class="info-card">
            <h2>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è</h2>
            
            <div class="stats-grid">
                <div class="stat-item">
                    <div class="stat-value">{{ application.conversations.count() }}</div>
                    <div class="stat-label">–í—Å–µ–≥–æ –¥–∏–∞–ª–æ–≥–æ–≤</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value">{{ application.conversations.filter_by(status='active').count() }}</div>
                    <div class="stat-label">–ê–∫—Ç–∏–≤–Ω—ã—Ö —á–∞—Ç–æ–≤</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value">
                        {% if application.average_rating %}
                            ‚≠ê {{ "%.1f"|format(application.average_rating) }}
                        {% else %}
                            ‚Äî
                        {% endif %}
                    </div>
                    <div class="stat-label">–°—Ä–µ–¥–Ω–∏–π —Ä–µ–π—Ç–∏–Ω–≥</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value">{{ application.total_messages or 0 }}</div>
                    <div class="stat-label">–°–æ–æ–±—â–µ–Ω–∏–π –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ</div>
                </div>
            </div>
        </div>

        <!-- –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ–º–æ—â–Ω–∏–∫–∞ -->
        {% if current_user.id == application.user_id or current_user.is_admin() %}
        <div class="info-card">
            <h2>–ü–∞—Ä–∞–º–µ—Ç—Ä—ã –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏</h2>
            
            <div class="info-row">
                <div class="info-label">
                    –¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞:
                    <button class="edit-btn" onclick="editField('temperature')" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—É">
                        <svg width="14" height="14" viewBox="0 0 16 16" fill="currentColor">
                            <path d="M12.146.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1 0 .708l-10 10a.5.5 0 0 1-.168.11l-5 2a.5.5 0 0 1-.65-.65l2-5a.5.5 0 0 1 .11-.168l10-10zM11.207 2.5L13.5 4.793 14.793 3.5 12.5 1.207 11.207 2.5zm1.586 3L10.5 3.207 4 9.707V10h.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.5h.293l6.5-6.5zm-9.761 5.175l-.106.106-1.528 3.821 3.821-1.528.106-.106A.5.5 0 0 1 5 12.5V12h-.5a.5.5 0 0 1-.5-.5V11h-.5a.5.5 0 0 1-.468-.325z"/>
                        </svg>
                    </button>
                </div>
                <div class="info-value">
                    <div id="temperature-display">{{ application.temperature or 0.7 }}</div>
                    <div id="temperature-edit" class="edit-form" style="display: none;">
                        <form method="post" action="{{ url_for('applications.update_settings', id=application.id) }}" class="inline-edit-form">
                            <input type="number" name="temperature" id="temperature-input" 
                                   min="0" max="1" step="0.1" 
                                   value="{{ application.temperature or 0.7 }}">
                            <span class="form-note">0 - —Ç–æ—á–Ω—ã–µ, 1 - –∫—Ä–µ–∞—Ç–∏–≤–Ω—ã–µ</span>
                            <button type="submit" class="button button-small">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                            <button type="button" class="button button-small button-secondary" onclick="cancelEdit('temperature')">–û—Ç–º–µ–Ω–∞</button>
                        </form>
                    </div>
                </div>
            </div>

            <div class="info-row">
                <div class="info-label">
                    –ú–∞–∫—Å. —Ç–æ–∫–µ–Ω–æ–≤:
                    <button class="edit-btn" onclick="editField('max_tokens')" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –º–∞–∫—Å. —Ç–æ–∫–µ–Ω—ã">
                        <svg width="14" height="14" viewBox="0 0 16 16" fill="currentColor">
                            <path d="M12.146.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1 0 .708l-10 10a.5.5 0 0 1-.168.11l-5 2a.5.5 0 0 1-.65-.65l2-5a.5.5 0 0 1 .11-.168l10-10zM11.207 2.5L13.5 4.793 14.793 3.5 12.5 1.207 11.207 2.5zm1.586 3L10.5 3.207 4 9.707V10h.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.5h.293l6.5-6.5zm-9.761 5.175l-.106.106-1.528 3.821 3.821-1.528.106-.106A.5.5 0 0 1 5 12.5V12h-.5a.5.5 0 0 1-.5-.5V11h-.5a.5.5 0 0 1-.468-.325z"/>
                        </svg>
                    </button>
                </div>
                <div class="info-value">
                    <div id="max_tokens-display">{{ application.max_tokens or 2000 }}</div>
                    <div id="max_tokens-edit" class="edit-form" style="display: none;">
                        <form method="post" action="{{ url_for('applications.update_settings', id=application.id) }}" class="inline-edit-form">
                            <input type="number" name="max_tokens" id="max_tokens-input" 
                                   min="100" max="8000" step="100"
                                   value="{{ application.max_tokens or 2000 }}">
                            <button type="submit" class="button button-small">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                            <button type="button" class="button button-small button-secondary" onclick="cancelEdit('max_tokens')">–û—Ç–º–µ–Ω–∞</button>
                        </form>
                    </div>
                </div>
            </div>

            <div class="info-row">
                <div class="info-label">
                    –°–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç:
                    <button class="edit-btn" onclick="editField('system_prompt')" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç">
                        <svg width="14" height="14" viewBox="0 0 16 16" fill="currentColor">
                            <path d="M12.146.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1 0 .708l-10 10a.5.5 0 0 1-.168.11l-5 2a.5.5 0 0 1-.65-.65l2-5a.5.5 0 0 1 .11-.168l10-10zM11.207 2.5L13.5 4.793 14.793 3.5 12.5 1.207 11.207 2.5zm1.586 3L10.5 3.207 4 9.707V10h.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.5h.293l6.5-6.5zm-9.761 5.175l-.106.106-1.528 3.821 3.821-1.528.106-.106A.5.5 0 0 1 5 12.5V12h-.5a.5.5 0 0 1-.5-.5V11h-.5a.5.5 0 0 1-.468-.325z"/>
                        </svg>
                    </button>
                </div>
                <div class="info-value">
                    <div id="system_prompt-display">{{ (application.system_prompt or '–¢—ã - –ø–æ–ª–µ–∑–Ω—ã–π –ø–æ–º–æ—â–Ω–∏–∫, –∫–æ—Ç–æ—Ä—ã–π –æ—Ç–≤–µ—á–∞–µ—Ç –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π.')[:100] }}{% if application.system_prompt and application.system_prompt|length > 100 %}...{% endif %}</div>
                    <div id="system_prompt-edit" class="edit-form" style="display: none;">
                        <form method="post" action="{{ url_for('applications.update_settings', id=application.id) }}">
                            <textarea name="system_prompt" id="system_prompt-input" rows="5">{{ application.system_prompt or '–¢—ã - –ø–æ–ª–µ–∑–Ω—ã–π –ø–æ–º–æ—â–Ω–∏–∫, –∫–æ—Ç–æ—Ä—ã–π –æ—Ç–≤–µ—á–∞–µ—Ç –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π.' }}</textarea>
                            <div class="form-actions">
                                <button type="submit" class="button button-small">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                                <button type="button" class="button button-small button-secondary" onclick="cancelEdit('system_prompt')">–û—Ç–º–µ–Ω–∞</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <div class="info-row">
                <div class="info-label">
                    –ü–æ–∏—Å–∫ –ø–æ –±–∞–∑–µ –∑–Ω–∞–Ω–∏–π:
                    <button class="edit-btn" onclick="editField('search_settings')" title="–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ–∏—Å–∫–∞">
                        <svg width="14" height="14" viewBox="0 0 16 16" fill="currentColor">
                            <path d="M12.146.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1 0 .708l-10 10a.5.5 0 0 1-.168.11l-5 2a.5.5 0 0 1-.65-.65l2-5a.5.5 0 0 1 .11-.168l10-10zM11.207 2.5L13.5 4.793 14.793 3.5 12.5 1.207 11.207 2.5zm1.586 3L10.5 3.207 4 9.707V10h.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.5h.293l6.5-6.5zm-9.761 5.175l-.106.106-1.528 3.821 3.821-1.528.106-.106A.5.5 0 0 1 5 12.5V12h-.5a.5.5 0 0 1-.5-.5V11h-.5a.5.5 0 0 1-.468-.325z"/>
                        </svg>
                    </button>
                </div>
                <div class="info-value">
                    <div id="search_settings-display">
                        {{ '–í–∫–ª—é—á–µ–Ω' if application.enable_search else '–í—ã–∫–ª—é—á–µ–Ω' }}
                        {% if application.enable_search %}
                        (–ª–∏–º–∏—Ç: {{ application.search_limit or 10 }}, —Ä–µ—Ä–µ–π—Ç–∏–Ω–≥: {{ '–¥–∞' if application.use_reranker else '–Ω–µ—Ç' }})
                        {% endif %}
                    </div>
                    <div id="search_settings-edit" class="edit-form" style="display: none;">
                        <form method="post" action="{{ url_for('applications.update_settings', id=application.id) }}">
                            <div class="checkbox-item">
                                <input type="checkbox" name="enable_search" id="enable_search" 
                                       {% if application.enable_search %}checked{% endif %}
                                       onchange="toggleSearchSettings()">
                                <label for="enable_search">–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø–æ–∏—Å–∫</label>
                            </div>
                            
                            <div id="searchSettings" style="{% if not application.enable_search %}display: none;{% endif %} margin-top: 10px;">
                                <div class="form-group">
                                    <label for="search_limit">–õ–∏–º–∏—Ç –ø–æ–∏—Å–∫–∞:</label>
                                    <input type="number" name="search_limit" id="search_limit" 
                                           min="1" max="50" 
                                           value="{{ application.search_limit or 10 }}" style="width: 80px;">
                                </div>
                                
                                <div class="checkbox-item">
                                    <input type="checkbox" name="use_reranker" id="use_reranker" 
                                           {% if application.use_reranker %}checked{% endif %}>
                                    <label for="use_reranker">–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ä–µ—Ä–µ–π—Ç–∏–Ω–≥</label>
                                </div>
                            </div>
                            
                            <div class="form-actions">
                                <button type="submit" class="button button-small">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                                <button type="button" class="button button-small button-secondary" onclick="cancelEdit('search_settings')">–û—Ç–º–µ–Ω–∞</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- –ò—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ —à–∞–±–ª–æ–Ω—ã –ø—Ä–æ–º–ø—Ç–æ–≤ -->
        <div class="info-card">
            <h2>–®–∞–±–ª–æ–Ω—ã –ø—Ä–æ–º–ø—Ç–æ–≤</h2>
            
            {% if application.checklists %}
                <div class="templates-list">
                    {% for template in application.checklists %}
                    <div class="template-item">
                        <div class="template-name">
                            <a href="{{ url_for('checklists.view', id=template.id) }}">{{ template.name }}</a>
                        </div>
                        <div class="template-type">
                            {% set type_badges = {
                                'support': ('üÜò', '–ü–æ–¥–¥–µ—Ä–∂–∫–∞'),
                                'analysis': ('üìä', '–ê–Ω–∞–ª–∏–∑'),
                                'qa': ('‚ùì', 'Q&A'),
                                'custom': ('‚öôÔ∏è', '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π')
                            } %}
                            {% set badge_info = type_badges.get(template.template_type or 'support', type_badges['support']) %}
                            <span class="badge">{{ badge_info[0] }} {{ badge_info[1] }}</span>
                        </div>
                        <div>
                            <a class="button button-small" href="{{ url_for('chat.chat_with_assistant', assistant_id=application.id) }}?template_id={{ template.id }}">–ß–∞—Ç —Å —ç—Ç–∏–º —à–∞–±–ª–æ–Ω–æ–º</a>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                
                {% if current_user.id == application.user_id or current_user.is_admin() %}
                <div class="form-actions">
                    <a href="{{ url_for('applications.add_checklist', id=application.id) }}" class="button button-small">–ò–∑–º–µ–Ω–∏—Ç—å —à–∞–±–ª–æ–Ω—ã</a>
                </div>
                {% endif %}
            {% else %}
                <p class="text-muted">–®–∞–±–ª–æ–Ω—ã –Ω–µ –≤—ã–±—Ä–∞–Ω—ã</p>
                {% if current_user.id == application.user_id or current_user.is_admin() %}
                <a href="{{ url_for('applications.add_checklist', id=application.id) }}" class="button button-small">–í—ã–±—Ä–∞—Ç—å —à–∞–±–ª–æ–Ω—ã</a>
                {% endif %}
            {% endif %}
        </div>

        <!-- –ë–∞–∑–∞ –∑–Ω–∞–Ω–∏–π -->
        <div class="info-card">
            <h2>–ë–∞–∑–∞ –∑–Ω–∞–Ω–∏–π</h2>
            
            {% if application.files.count() > 0 %}
                <div class="files-stats">
                    <p>–ó–∞–≥—Ä—É–∂–µ–Ω–æ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤: <strong>{{ application.files.count() }}</strong></p>
                    <p>–í—Å–µ–≥–æ —á–∞–Ω–∫–æ–≤ –≤ –±–∞–∑–µ: <strong>{{ application.total_chunks or 0 }}</strong></p>
                </div>
                
                <div class="files-list">
                    {% for file in application.files.all() %}
                    <div class="file-item">
                        <span class="file-name">üìÑ {{ file.original_name }}</span>
                        <span class="file-status status-{{ file.indexing_status }}">
                            {% if file.indexing_status == 'completed' %}
                                ‚úÖ –ü—Ä–æ–∏–Ω–¥–µ–∫—Å–∏—Ä–æ–≤–∞–Ω
                            {% elif file.indexing_status == 'indexing' %}
                                ‚è≥ –ò–Ω–¥–µ–∫—Å–∏—Ä—É–µ—Ç—Å—è...
                            {% elif file.indexing_status == 'error' %}
                                ‚ùå –û—à–∏–±–∫–∞
                            {% else %}
                                ‚è∏Ô∏è –û–∂–∏–¥–∞–µ—Ç
                            {% endif %}
                        </span>
                    </div>
                    {% endfor %}
                </div>
            {% else %}
                <p class="text-muted">–ë–∞–∑–∞ –∑–Ω–∞–Ω–∏–π –ø—É—Å—Ç–∞</p>
            {% endif %}
            
            {% if current_user.id == application.user_id or current_user.is_admin() %}
            <div class="form-actions">
                <a href="{{ url_for('applications.upload_file', id=application.id) }}" class="button button-small">–ó–∞–≥—Ä—É–∑–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç—ã</a>
            </div>
            {% endif %}
        </div>

        <!-- –î–µ–π—Å—Ç–≤–∏—è -->
        {% if current_user.id == application.user_id or current_user.is_admin() %}
        <div class="action-buttons">
            <a href="{{ url_for('chat.chat_with_assistant', assistant_id=application.id) }}" class="button button-primary">üí¨ –û—Ç–∫—Ä—ã—Ç—å —á–∞—Ç</a>
            <form action="{{ url_for('applications.delete', id=application.id) }}" method="post" class="inline-form">
                <button type="submit" class="button button-danger" onclick="return confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã? –í—Å–µ –¥–∞–Ω–Ω—ã–µ –ø–æ–º–æ—â–Ω–∏–∫–∞ –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã.')">
                    –£–¥–∞–ª–∏—Ç—å –ø–æ–º–æ—â–Ω–∏–∫–∞
                </button>
            </form>
        </div>
        {% endif %}
    </div>

    <style>
        .assistant-details {
            margin-top: 20px;
        }

        .info-card {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .info-card h2 {
            margin-top: 0;
            margin-bottom: 15px;
            color: #343a40;
        }

        .info-row {
            display: flex;
            padding: 10px 0;
            border-bottom: 1px solid #e9ecef;
        }

        .info-row:last-child {
            border-bottom: none;
        }

        .info-label {
            font-weight: 600;
            color: #495057;
            width: 200px;
            display: flex;
            align-items: center;
        }

        .info-value {
            flex: 1;
            color: #212529;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 20px;
            margin-top: 15px;
        }

        .stat-item {
            text-align: center;
            padding: 15px;
            background-color: white;
            border-radius: 6px;
            border: 1px solid #dee2e6;
        }

        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #007bff;
        }

        .stat-label {
            font-size: 12px;
            color: #6c757d;
            margin-top: 5px;
        }

        .templates-list {
            margin-top: 15px;
        }

        .template-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background-color: white;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            margin-bottom: 10px;
        }

        .files-list {
            margin-top: 15px;
        }

        .file-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            background-color: white;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            margin-bottom: 8px;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            padding: 20px;
            background-color: #f8f9fa;
            border-radius: 8px;
        }

        .edit-btn {
            background: none;
            border: none;
            cursor: pointer;
            color: #007bff;
            padding: 2px 6px;
            margin-left: 10px;
            border-radius: 4px;
            transition: all 0.2s;
            vertical-align: middle;
        }

        .edit-btn:hover {
            background-color: #e9ecef;
            color: #0056b3;
        }

        .edit-form {
            margin: 10px 0;
            animation: fadeIn 0.3s ease-in;
        }

        .inline-edit-form {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .inline-edit-form input[type="text"],
        .inline-edit-form input[type="number"],
        .inline-edit-form select {
            padding: 8px;
            font-size: 1rem;
            border: 1px solid #ced4da;
            border-radius: 4px;
        }
        
        .inline-edit-form input[type="number"] {
            width: 100px;
        }
        
        .inline-edit-form select {
            min-width: 200px;
        }
        
        #system_prompt-input {
            width: 100%;
            padding: 8px;
            margin-bottom: 10px;
            font-family: inherit;
            font-size: 0.95rem;
            border: 1px solid #ced4da;
            border-radius: 4px;
            resize: vertical;
        }
        
        .form-note {
            color: #6c757d;
            font-size: 0.85rem;
            margin: 0 5px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            margin: 8px 0;
        }

        .checkbox-item input[type="checkbox"] {
            width: auto;
            margin-right: 10px;
        }
        
        .checkbox-item label {
            margin: 0;
            cursor: pointer;
            font-size: 0.95rem;
        }

        .badge {
            display: inline-block;
            padding: 0.25em 0.6em;
            font-size: 0.75em;
            font-weight: 700;
            line-height: 1;
            text-align: center;
            white-space: nowrap;
            vertical-align: baseline;
            border-radius: 0.25rem;
        }

        .badge-success {
            color: #fff;
            background-color: #28a745;
        }

        .badge-secondary {
            color: #fff;
            background-color: #6c757d;
        }
        
        /* –°—Ç–∏–ª–∏ –¥–ª—è –±–ª–æ–∫–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –ø–æ–∏—Å–∫–∞ */
        #searchSettings {
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            border: 1px solid #e9ecef;
            margin-top: 10px;
        }
        
        #searchSettings .form-group {
            margin: 10px 0;
        }
        
        #searchSettings label {
            font-size: 0.9rem;
            margin-right: 10px;
            display: inline-block;
            min-width: 100px;
        }
        
        /* –ê–Ω–∏–º–∞—Ü–∏—è –ø–æ—è–≤–ª–µ–Ω–∏—è */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(-5px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>

    <script>
        // –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è inline-—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        function editField(fieldName) {
            const display = document.getElementById(fieldName + '-display');
            const edit = document.getElementById(fieldName + '-edit');
            
            if (display) display.style.display = 'none';
            if (edit) {
                edit.style.display = 'block';
                
                // –§–æ–∫—É—Å –Ω–∞ –ø–æ–ª–µ –≤–≤–æ–¥–∞
                const input = document.getElementById(fieldName + '-input');
                if (input) {
                    if (input.type === 'text' || input.type === 'number') {
                        input.focus();
                        input.select();
                    } else if (input.tagName === 'TEXTAREA') {
                        input.focus();
                    } else if (input.tagName === 'SELECT') {
                        input.focus();
                    }
                }
            }
        }
        
        function cancelEdit(fieldName) {
            const display = document.getElementById(fieldName + '-display');
            const edit = document.getElementById(fieldName + '-edit');
            
            if (display) display.style.display = 'block';
            if (edit) edit.style.display = 'none';
            
            // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∏—Å—Ö–æ–¥–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
        }
        
        // –ü–æ–∫–∞–∑/—Å–∫—Ä—ã—Ç–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –ø–æ–∏—Å–∫–∞
        function toggleSearchSettings() {
            const checkbox = document.getElementById('enable_search');
            const settings = document.getElementById('searchSettings');
            if (checkbox.checked) {
                settings.style.display = 'block';
            } else {
                settings.style.display = 'none';
            }
        }
        
        // –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞–∑–≤–∞–Ω–∏—è
        const editNameBtn = document.getElementById('edit-name-btn');
        const nameDisplay = document.getElementById('assistant-name-display');
        const editNameForm = document.getElementById('edit-name-form');
        const nameInput = document.getElementById('name-input');

        if (editNameBtn) {
            editNameBtn.addEventListener('click', function() {
                nameDisplay.style.display = 'none';
                editNameBtn.style.display = 'none';
                editNameForm.style.display = 'block';
                nameInput.focus();
                nameInput.select();
            });
        }

        function cancelEditName() {
            nameDisplay.style.display = 'inline';
            if (editNameBtn) editNameBtn.style.display = 'inline';
            editNameForm.style.display = 'none';
            nameInput.value = {{ application.name|tojson|safe }};
        }

        // –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ–ø–∏—Å–∞–Ω–∏—è
        const editDescriptionBtn = document.getElementById('edit-description-btn');
        const descriptionDisplay = document.getElementById('description-display');
        const editDescriptionForm = document.getElementById('edit-description-form');
        const descriptionInput = document.getElementById('description-input');

        if (editDescriptionBtn) {
            editDescriptionBtn.addEventListener('click', function() {
                descriptionDisplay.style.display = 'none';
                editDescriptionBtn.style.display = 'none';
                editDescriptionForm.style.display = 'block';
                descriptionInput.focus();
            });
        }

        function cancelEditDescription() {
            descriptionDisplay.style.display = 'block';
            if (editDescriptionBtn) editDescriptionBtn.style.display = 'inline';
            editDescriptionForm.style.display = 'none';
            descriptionInput.value = {{ (application.description or '')|tojson|safe }};
        }
        
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–∞–∂–∞—Ç–∏—è Escape –¥–ª—è –æ—Ç–º–µ–Ω—ã –ª—é–±–æ–≥–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                // –ó–∞–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ –æ—Ç–∫—Ä—ã—Ç—ã–µ —Ñ–æ—Ä–º—ã —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
                const allEditForms = document.querySelectorAll('.edit-form');
                allEditForms.forEach(form => {
                    if (form.style.display !== 'none') {
                        const fieldName = form.id.replace('-edit', '');
                        cancelEdit(fieldName);
                    }
                });
                
                // –°–ø–µ—Ü–∏–∞–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –¥–ª—è –∏–º–µ–Ω–∏ –∏ –æ–ø–∏—Å–∞–Ω–∏—è
                if (editNameForm && editNameForm.style.display === 'block') {
                    cancelEditName();
                }
                if (editDescriptionForm && editDescriptionForm.style.display === 'block') {
                    cancelEditDescription();
                }
            }
        });
    </script>
{% endblock %}