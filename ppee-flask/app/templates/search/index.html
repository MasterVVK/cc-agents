{% extends "base.html" %}

{% block content %}
    <div class="page-header">
        <div class="header-title">
            <h1>üîç –ü–æ–∏—Å–∫ –ø–æ –±–∞–∑–µ –∑–Ω–∞–Ω–∏–π</h1>
            {% if current_user.is_admin() or current_user.is_prompt_engineer() %}
            <label class="checkbox-label">
                <input type="checkbox" id="show-all-applications" onchange="toggleApplicationsView()">
                <span>–ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ—Ö –ø–æ–º–æ—â–Ω–∏–∫–æ–≤</span>
            </label>
            {% endif %}
        </div>
    </div>
    <div class="search-container">
        <form id="search-form" method="post" class="search-form">
            <div class="form-group">
                <label for="application_id">–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–º–æ—â–Ω–∏–∫–∞ (–±–∞–∑—É –∑–Ω–∞–Ω–∏–π)</label>
                <select id="application_id" name="application_id" required>
                    <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–º–æ—â–Ω–∏–∫–∞ --</option>
                    {% for app in applications %}
                        <option value="{{ app.id }}"
                                class="application-option"
                                data-owner-id="{{ app.user_id if app.user_id else '' }}"
                                {% if app.user_id != current_user.id %}style="display: none;"{% endif %}>
                            {{ app.name }} (ID: {{ app.id }})
                            {% if current_user.is_admin() or current_user.is_prompt_engineer() %}
                                {% if app.user %}
                                    - {% if app.user.id == current_user.id %}–í—ã{% else %}{{ app.user.username }}{% endif %}
                                {% endif %}
                            {% endif %}
                        </option>
                    {% endfor %}
                </select>
            </div>

            <div class="form-group">
                <label for="query">–ü–æ–∏—Å–∫–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å</label>
                <input type="text" id="query" name="query" placeholder="–í–≤–µ–¥–∏—Ç–µ –ø–æ–∏—Å–∫–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å..." required>
            </div>

            <h3>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ–∏—Å–∫–∞</h3>

            <div class="form-row">
                <div class="form-group half-width">
                    <label for="search_limit">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤</label>
                    <select id="search_limit" name="search_limit">
                        <option value="1">1</option>
                        <option value="2">2</option>
                        <option value="3" selected>3</option>
                        <option value="4">4</option>
                        <option value="5">5</option>
                        <option value="6">6</option>
                        <option value="7">7</option>
                        <option value="8">8</option>
                    </select>
                    <p class="form-note">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ø–æ–∏—Å–∫–∞ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è</p>
                </div>

                <div class="form-group half-width">
                    <div class="checkbox-item">
                        <input type="checkbox" id="use_reranker" name="use_reranker" value="true">
                        <label for="use_reranker">–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ä–µ—Ä–µ–π—Ç–∏–Ω–≥</label>
                    </div>
                    <p class="form-note">–†–µ—Ä–µ–π—Ç–∏–Ω–≥ —É–ª—É—á—à–∞–µ—Ç –∫–∞—á–µ—Å—Ç–≤–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤, –Ω–æ —Ç—Ä–µ–±—É–µ—Ç –±–æ–ª—å—à–µ —Ä–µ—Å—É—Ä—Å–æ–≤</p>
                </div>
            </div>

            <div class="form-group rerank-limit-container" style="display: none;">
                <label for="rerank_limit">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –¥–ª—è —Ä–µ—Ä–µ–π—Ç–∏–Ω–≥–∞</label>
                <select id="rerank_limit" name="rerank_limit">
                    <option value="5">5</option>
                    <option value="10" selected>10</option>
                    <option value="15">15</option>
                    <option value="20">20</option>
                    <option value="30">30</option>
                    <option value="9999">–í—Å–µ —á–∞–Ω–∫–∏ –≤ –∑–∞—è–≤–∫–µ</option>
                </select>
                <p class="form-note">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤, –∏–∑–≤–ª–µ–∫–∞–µ–º—ã—Ö –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è —Ä–µ—Ä–µ–π—Ç–∏–Ω–≥–∞</p>
            </div>

            <!-- –î–æ–±–∞–≤–ª—è–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è —É–º–Ω–æ–≥–æ/–≥–∏–±—Ä–∏–¥–Ω–æ–≥–æ –ø–æ–∏—Å–∫–∞ -->
            <div class="form-group">
                <div class="checkbox-item">
                    <input type="checkbox" id="use_smart_search" name="use_smart_search" value="true" checked>
                    <label for="use_smart_search">–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —É–º–Ω—ã–π –ø–æ–∏—Å–∫</label>
                </div>
                <p class="form-note">–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—ã–±–∏—Ä–∞–µ—Ç –º–µ—Ç–æ–¥ –ø–æ–∏—Å–∫–∞ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –¥–ª–∏–Ω—ã –∑–∞–ø—Ä–æ—Å–∞</p>
            </div>

            <div id="hybrid-settings" style="display: none;">
                <h3>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –≥–∏–±—Ä–∏–¥–Ω–æ–≥–æ –ø–æ–∏—Å–∫–∞</h3>
                <div class="form-row">
                    <div class="form-group half-width">
                        <label for="vector_weight">–í–µ—Å –≤–µ–∫—Ç–æ—Ä–Ω–æ–≥–æ –ø–æ–∏—Å–∫–∞</label>
                        <input type="number" id="vector_weight" name="vector_weight" min="0" max="1" step="0.1" value="0.5">
                        <p class="form-note">–ó–Ω–∞—á–µ–Ω–∏–µ –æ—Ç 0.0 –¥–æ 1.0, –≤–ª–∏—è–µ—Ç –Ω–∞ –≤–∞–∂–Ω–æ—Å—Ç—å —Å–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–æ–≥–æ –ø–æ–∏—Å–∫–∞</p>
                    </div>
                    <div class="form-group half-width">
                        <label for="text_weight">–í–µ—Å —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ –ø–æ–∏—Å–∫–∞</label>
                        <input type="number" id="text_weight" name="text_weight" min="0" max="1" step="0.1" value="0.5">
                        <p class="form-note">–ó–Ω–∞—á–µ–Ω–∏–µ –æ—Ç 0.0 –¥–æ 1.0, –≤–ª–∏—è–µ—Ç –Ω–∞ –≤–∞–∂–Ω–æ—Å—Ç—å –ø–æ–ª–Ω–æ—Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ –ø–æ–∏—Å–∫–∞</p>
                    </div>
                </div>
                <div class="form-group">
                    <label for="hybrid_threshold">–ü–æ—Ä–æ–≥ –¥–ª—è –≥–∏–±—Ä–∏–¥–Ω–æ–≥–æ –ø–æ–∏—Å–∫–∞</label>
                    <input type="number" id="hybrid_threshold" name="hybrid_threshold" min="1" max="100" value="50">
                    <p class="form-note">–î–ª–∏–Ω–∞ –∑–∞–ø—Ä–æ—Å–∞ –≤ —Å–∏–º–≤–æ–ª–∞—Ö, –ø—Ä–∏ –∫–æ—Ç–æ—Ä–æ–π –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≥–∏–±—Ä–∏–¥–Ω—ã–π –ø–æ–∏—Å–∫</p>
                </div>
            </div>

            <h3>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ LLM –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</h3>

            <div class="form-group">
                <div class="checkbox-item">
                    <input type="checkbox" id="use_llm" name="use_llm" value="true">
                    <label for="use_llm">–û–±—Ä–∞–±–æ—Ç–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —á–µ—Ä–µ–∑ LLM</label>
                </div>
                <p class="form-note">–ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –∑–Ω–∞—á–µ–Ω–∏—è –∏–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ø–æ–∏—Å–∫–∞ —Å –ø–æ–º–æ—â—å—é LLM</p>
            </div>

            <div id="llm-settings" style="display: none;">
                <div class="form-group">
                    <label for="llm_model">–ú–æ–¥–µ–ª—å LLM</label>
                    <select id="llm_model" name="llm_model">
                        {% for model in available_models %}
                            <option value="{{ model }}" {% if model == default_llm_model %}selected{% endif %}>{{ model }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="form-group">
                    <label for="llm_prompt_template">–ü—Ä–æ–º–ø—Ç –∫ LLM</label>
                    <textarea id="llm_prompt_template" name="llm_prompt_template" rows="10" placeholder="–í–≤–µ–¥–∏—Ç–µ –ø—Ä–æ–º–ø—Ç...">{{ default_prompt }}</textarea>
                    <p class="form-note">–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ {query} –¥–ª—è –≤—Å—Ç–∞–≤–∫–∏ –ø–æ–∏—Å–∫–æ–≤–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞ –∏ {context} –¥–ª—è –≤—Å—Ç–∞–≤–∫–∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –∏–∑ –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤</p>
                </div>

                <div class="form-row">
                    <div class="form-group half-width">
                        <label for="llm_temperature">Temperature</label>
                        <input type="number" id="llm_temperature" name="llm_temperature" step="0.1" min="0" max="1" value="0.1">
                        <p class="form-note">–ó–Ω–∞—á–µ–Ω–∏–µ –æ—Ç 0.0 –¥–æ 1.0, –≤–ª–∏—è–µ—Ç –Ω–∞ –∫—Ä–µ–∞—Ç–∏–≤–Ω–æ—Å—Ç—å –æ—Ç–≤–µ—Ç–æ–≤</p>
                    </div>

                    <div class="form-group half-width">
                        <label for="llm_max_tokens">Max Tokens</label>
                        <input type="number" id="llm_max_tokens" name="llm_max_tokens" min="100" max="4000" value="1000">
                        <p class="form-note">–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –¥–ª–∏–Ω–∞ –æ—Ç–≤–µ—Ç–∞ –≤ —Ç–æ–∫–µ–Ω–∞—Ö</p>
                    </div>
                </div>
            </div>

            <div class="form-actions">
                <button type="submit" id="search-button" class="button">–í—ã–ø–æ–ª–Ω–∏—Ç—å –ø–æ–∏—Å–∫</button>
                <button type="button" id="stop-button" class="button button-danger" style="display: none;">–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø–æ–∏—Å–∫</button>
            </div>
        </form>

        <!-- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –¥–ª—è –ø–æ–∏—Å–∫–∞ (–ë–ï–ó –°–¢–ê–î–ò–ô) -->
        <div id="search-progress" class="search-progress" style="display: none;">
            <h3>–í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –ø–æ–∏—Å–∫–∞</h3>
            <div class="progress">
                <div id="progress-bar" class="progress-bar progress-bar-striped progress-bar-animated"
                     role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" style="width: 0%"></div>
            </div>
            <p id="status-message">–í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –ø–æ–∏—Å–∫...</p>
        </div>

        <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ -->
        <div id="results-container" class="results-container" style="display: none;">
            <h2>–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞</h2>
            <div id="results-stats" class="results-stats"></div>

            <!-- –ë–ª–æ–∫ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ LLM -->
            <div id="llm-result" class="llm-result" style="display: none;">
                <h3>–ò–∑–≤–ª–µ—á–µ–Ω–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ (LLM)</h3>
                <div class="info-card">
                    <div id="llm-value" class="llm-value"></div>
                    <div id="llm-confidence" class="confidence-container">
                        <p>–£–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å:</p>
                        <div class="confidence-bar">
                            <div id="confidence-value" class="confidence-value" style="width: 0%"></div>
                            <span id="confidence-text">0%</span>
                        </div>
                    </div>
                </div>
            </div>

            <h3>–ù–∞–π–¥–µ–Ω–Ω—ã–µ —á–∞–Ω–∫–∏</h3>
            <div id="search-results" class="search-results"></div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // –≠–ª–µ–º–µ–Ω—Ç—ã –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º –Ω–∞—Å—Ç—Ä–æ–µ–∫
            const useRerankerCheckbox = document.getElementById('use_reranker');
            const rerankLimitContainer = document.querySelector('.rerank-limit-container');
            const useLlmCheckbox = document.getElementById('use_llm');
            const llmSettings = document.getElementById('llm-settings');

            // –≠–ª–µ–º–µ–Ω—Ç—ã –¥–ª—è –≥–∏–±—Ä–∏–¥–Ω–æ–≥–æ –ø–æ–∏—Å–∫–∞
            const useSmartSearchCheckbox = document.getElementById('use_smart_search');
            const hybridSettings = document.getElementById('hybrid-settings');

            // –≠–ª–µ–º–µ–Ω—Ç—ã —Ñ–æ—Ä–º—ã –∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
            const searchForm = document.getElementById('search-form');
            const resultsContainer = document.getElementById('results-container');
            const resultsStats = document.getElementById('results-stats');
            const searchResults = document.getElementById('search-results');
            const llmResult = document.getElementById('llm-result');
            const llmValue = document.getElementById('llm-value');
            const confidenceValue = document.getElementById('confidence-value');
            const confidenceText = document.getElementById('confidence-text');

            // –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
            const searchButton = document.getElementById('search-button');
            const stopButton = document.getElementById('stop-button');

            // –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –∑–∞–¥–∞—á–∏
            let searchTracker = null;
            let currentTaskId = null;

            // –î–æ–±–∞–≤–ª—è–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –æ–ø—Ü–∏–∏ "–í—Å–µ —á–∞–Ω–∫–∏"
            const applicationSelect = document.getElementById('application_id');
            const rerankLimitSelect = document.getElementById('rerank_limit');
            const allChunksOption = rerankLimitSelect.querySelector('option[value="9999"]');

            // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–µ–∫—Å—Ç–∞ –æ–ø—Ü–∏–∏ "–í—Å–µ —á–∞–Ω–∫–∏"
            async function updateAllChunksOption() {
                const applicationId = applicationSelect.value;

                if (!applicationId || !allChunksOption) {
                    return;
                }

                try {
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏—Å—Ö–æ–¥–Ω—ã–π —Ç–µ–∫—Å—Ç
                    allChunksOption.textContent = '–í—Å–µ —á–∞–Ω–∫–∏ –≤ –∑–∞—è–≤–∫–µ (–∑–∞–≥—Ä—É–∑–∫–∞...)';

                    // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
                    const response = await fetch(`/applications/${applicationId}/api/stats`);
                    if (response.ok) {
                        const data = await response.json();
                        const totalChunks = data.total_chunks || 0;
                        allChunksOption.textContent = `–í—Å–µ —á–∞–Ω–∫–∏ –≤ –∑–∞—è–≤–∫–µ (${totalChunks})`;
                    } else {
                        allChunksOption.textContent = '–í—Å–µ —á–∞–Ω–∫–∏ –≤ –∑–∞—è–≤–∫–µ';
                    }
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —á–∞–Ω–∫–æ–≤:', error);
                    allChunksOption.textContent = '–í—Å–µ —á–∞–Ω–∫–∏ –≤ –∑–∞—è–≤–∫–µ';
                }
            }

            // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫ —Ä–µ—Ä–µ–π—Ç–∏–Ω–≥–∞
            function updateRerankSettings() {
                if (useRerankerCheckbox.checked) {
                    rerankLimitContainer.style.display = 'block';
                    // –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —á–∞–Ω–∫–æ–≤ –ø—Ä–∏ –ø–æ–∫–∞–∑–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫
                    if (applicationSelect.value) {
                        updateAllChunksOption();
                    }
                } else {
                    rerankLimitContainer.style.display = 'none';
                }
            }

            // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫ LLM
            function updateLlmSettings() {
                if (useLlmCheckbox.checked) {
                    llmSettings.style.display = 'block';
                } else {
                    llmSettings.style.display = 'none';
                }
            }

            // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫ –≥–∏–±—Ä–∏–¥–Ω–æ–≥–æ –ø–æ–∏—Å–∫–∞
            function updateHybridSettings() {
                if (useSmartSearchCheckbox.checked) {
                    hybridSettings.style.display = 'block';
                } else {
                    hybridSettings.style.display = 'none';
                }
            }

            // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
            function showResults(data) {
                // –°–∫—Ä—ã–≤–∞–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å
                document.getElementById('search-progress').style.display = 'none';

                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –ø–æ–∏—Å–∫–∞, —Å–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –æ—Å—Ç–∞–Ω–æ–≤–∫–∏
                searchButton.style.display = 'inline-block';
                stopButton.style.display = 'none';

                // –ï—Å–ª–∏ –ø–æ–∏—Å–∫ –±—ã–ª –æ—Ç–º–µ–Ω–µ–Ω
                if (data.status === 'cancelled') {
                    resultsContainer.style.display = 'block';
                    resultsStats.innerHTML = '<p class="alert alert-warning">–ü–æ–∏—Å–∫ –±—ã–ª –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º.</p>';
                    searchResults.innerHTML = '';
                    return;
                }

                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
                resultsContainer.style.display = 'block';

                // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –º–µ—Ç–æ–¥–µ –ø–æ–∏—Å–∫–∞
                let searchMethodText = "";
                if (data.use_smart_search) {
                    if (data.search_method === "hybrid") {
                        searchMethodText = "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω <strong>–≥–∏–±—Ä–∏–¥–Ω—ã–π –ø–æ–∏—Å–∫</strong> (–∫–æ—Ä–æ—Ç–∫–∏–π –∑–∞–ø—Ä–æ—Å)";
                    } else {
                        searchMethodText = "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω <strong>–≤–µ–∫—Ç–æ—Ä–Ω—ã–π –ø–æ–∏—Å–∫</strong> (–¥–ª–∏–Ω–Ω—ã–π –∑–∞–ø—Ä–æ—Å)";
                    }
                } else if (data.use_reranker) {
                    searchMethodText = "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω <strong>–≤–µ–∫—Ç–æ—Ä–Ω—ã–π –ø–æ–∏—Å–∫ —Å —Ä–µ—Ä–µ–π—Ç–∏–Ω–≥–æ–º</strong>";
                } else {
                    searchMethodText = "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω <strong>–≤–µ–∫—Ç–æ—Ä–Ω—ã–π –ø–æ–∏—Å–∫</strong>";
                }

                const statsText = `–ù–∞–π–¥–µ–Ω–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤: <strong>${data.count}</strong>. ${searchMethodText}`;

                resultsStats.innerHTML = `<p>${statsText}</p>`;
                if (data.execution_time) {
                    resultsStats.innerHTML += `<p>–í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è: <strong>${data.execution_time}</strong> —Å–µ–∫.</p>`;
                }

                // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç LLM, –µ—Å–ª–∏ –µ—Å—Ç—å
                if (data.llm_result) {
                    llmResult.style.display = 'block';
                    llmValue.textContent = data.llm_result.value;

                    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç–∏
                    const confidence = data.llm_result.confidence * 100;
                    confidenceValue.style.width = `${confidence}%`;
                    confidenceText.textContent = `${Math.round(confidence)}%`;

                    // –ú–µ–Ω—è–µ–º —Ü–≤–µ—Ç –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç–∏
                    if (confidence > 75) {
                        confidenceValue.style.backgroundColor = '#28a745'; // –∑–µ–ª–µ–Ω—ã–π
                    } else if (confidence > 50) {
                        confidenceValue.style.backgroundColor = '#ffc107'; // –∂–µ–ª—Ç—ã–π
                    } else {
                        confidenceValue.style.backgroundColor = '#dc3545'; // –∫—Ä–∞—Å–Ω—ã–π
                    }
                } else {
                    llmResult.style.display = 'none';
                }

                // –û—á–∏—â–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
                searchResults.innerHTML = '';

                // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
                if (data.results && data.results.length > 0) {
                    data.results.forEach(result => {
                        const resultItem = document.createElement('div');
                        resultItem.className = 'result-item';

                        // –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç–∏ –∏ –º–µ—Ç–æ–¥–µ –ø–æ–∏—Å–∫–∞
                        let scoreHtml = `<span class="result-score">–†–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç—å: ${result.score}</span>`;
                        let searchTypeDisplay = "";

                        if (result.search_type === "hybrid") {
                            searchTypeDisplay = `<span class="result-search-type result-hybrid">–ì–∏–±—Ä–∏–¥–Ω—ã–π –ø–æ–∏—Å–∫</span>`;
                        } else if (result.search_type === "text") {
                            searchTypeDisplay = `<span class="result-search-type result-text">–¢–µ–∫—Å—Ç–æ–≤—ã–π –ø–æ–∏—Å–∫</span>`;
                        } else {
                            searchTypeDisplay = `<span class="result-search-type result-vector">–í–µ–∫—Ç–æ—Ä–Ω—ã–π –ø–æ–∏—Å–∫</span>`;
                        }

                        if (data.use_reranker && result.rerank_score) {
                            scoreHtml = `
                                <span class="result-score-rerank">–†–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç—å (—Ä–µ—Ä–µ–π—Ç–∏–Ω–≥): ${result.rerank_score}</span>
                                <span class="result-score">–†–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç—å (–≤–µ–∫—Ç–æ—Ä–Ω–∞—è): ${result.score}</span>
                            `;
                        }

                        resultItem.innerHTML = `
                            <div class="result-header">
                                <span class="result-position">${result.position}</span>
                                <div class="result-meta">
                                    <span class="result-document">–§–∞–∏–ª: ${result.document_name}</span>
                                    <span class="result-page">–°—Ç—Ä–∞–Ω–∏—Ü–∞: ${result.page_number || '–ù–µ —É–∫–∞–∑–∞–Ω–∞'}</span>
                                    ${searchTypeDisplay}
                                    ${scoreHtml}
                                </div>
                            </div>
                            <div class="result-content">${result.text}</div>
                        `;

                        searchResults.appendChild(resultItem);
                    });
                } else {
                    searchResults.innerHTML = '<p class="no-results">–ü–æ –≤–∞—à–µ–º—É –∑–∞–ø—Ä–æ—Å—É –Ω–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</p>';
                }
            }

            // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–∫–∏ —Å –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
            function handleSearchError(error) {
                // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏
                searchButton.style.display = 'inline-block';
                stopButton.style.display = 'none';

                // –°–∫—Ä—ã–≤–∞–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å
                document.getElementById('search-progress').style.display = 'none';

                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—à–∏–±–∫—É
                resultsContainer.style.display = 'block';
                resultsStats.innerHTML = `<p class="alert alert-error">–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ –ø–æ–∏—Å–∫–∞: ${error.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}</p>`;
                searchResults.innerHTML = '';
            }

            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏
            stopButton.addEventListener('click', function() {
                if (currentTaskId) {
                    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ –æ—Å—Ç–∞–Ω–æ–≤–∫—É –∑–∞–¥–∞—á–∏
                    fetch(`/search/cancel/${currentTaskId}`, {
                        method: 'POST'
                    })
                    .then(response => response.json())
                    .then(data => {
                        console.log('–ó–∞–¥–∞—á–∞ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞:', data);

                        // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç—Ä–µ–∫–µ—Ä
                        if (searchTracker) {
                            searchTracker._stopTracking();
                        }

                        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—Ç–º–µ–Ω–µ
                        showResults({
                            status: 'cancelled',
                            count: 0,
                            results: []
                        });
                    })
                    .catch(error => {
                        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Å—Ç–∞–Ω–æ–≤–∫–µ –∑–∞–¥–∞—á–∏:', error);
                        handleSearchError(error);
                    });
                }
            });

            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ä–º—ã
            searchForm.addEventListener('submit', function(e) {
                e.preventDefault();

                // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π —Ç—Ä–µ–∫–µ—Ä
                if (searchTracker) {
                    searchTracker._stopTracking();
                }

                // –°–∫—Ä—ã–≤–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
                resultsContainer.style.display = 'none';
                llmResult.style.display = 'none';

                // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º –∫–Ω–æ–ø–∫–∏
                searchButton.style.display = 'none';
                stopButton.style.display = 'inline-block';

                // –§–æ—Ä–º–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏
                const formData = new FormData(searchForm);

                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å-–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
                document.getElementById('search-progress').style.display = 'block';

                // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π —Ç—Ä–µ–∫–µ—Ä –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –¥–ª—è –ø–æ–∏—Å–∫–∞
                searchTracker = new TaskProgressTracker({
                    statusUrl: "/search/status",
                    progressBarId: "progress-bar",
                    statusMessageId: "status-message",
                    progressContainerId: "search-progress",
                    resultsContainerId: "results-container",
                    onComplete: showResults,
                    onError: handleSearchError,
                    checkInterval: 500
                });

                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ –ø–æ–∏—Å–∫
                fetch('/search/execute', {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'pending') {
                        // –°–æ—Ö—Ä–∞–Ω—è–µ–º ID –∑–∞–¥–∞—á–∏
                        currentTaskId = data.task_id;

                        // –ü–æ–ª—É—á–µ–Ω ID –∑–∞–¥–∞—á–∏ - –Ω–∞—á–∏–Ω–∞–µ–º –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å
                        console.log("–ù–∞—á–∏–Ω–∞–µ–º –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏", data.task_id);
                        searchTracker.startTracking(data.task_id);
                    } else if (data.status === 'error') {
                        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—à–∏–±–∫—É
                        console.error("–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ –∑–∞–¥–∞—á–∏:", data);
                        handleSearchError(data);
                    }
                })
                .catch(error => {
                    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ –∑–∞–¥–∞—á–∏ –ø–æ–∏—Å–∫–∞:', error);
                    handleSearchError({
                        message: `–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ –∑–∞–¥–∞—á–∏: ${error.message}`
                    });
                });
            });

            // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–∏ —Å–º–µ–Ω–µ –∑–∞—è–≤–∫–∏
            applicationSelect.addEventListener('change', updateAllChunksOption);

            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏ —É—Å—Ç–∞–Ω–æ–≤–∫–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ —Å–æ–±—ã—Ç–∏–π
            updateRerankSettings();
            updateLlmSettings();
            updateHybridSettings();
            useRerankerCheckbox.addEventListener('change', updateRerankSettings);
            useLlmCheckbox.addEventListener('change', updateLlmSettings);
            useSmartSearchCheckbox.addEventListener('change', updateHybridSettings);
            // –¢–µ–∫—É—â–∏–π ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            const currentUserId = {{ current_user.id }};

            // –§—É–Ω–∫—Ü–∏—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –≤–∏–¥–∞ –∑–∞—è–≤–æ–∫
            function toggleApplicationsView() {
                const checkbox = document.getElementById('show-all-applications');
                const select = document.getElementById('application_id');
                const options = select.querySelectorAll('.application-option');

                // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â–µ–µ –≤—ã–±—Ä–∞–Ω–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
                const currentValue = select.value;
                let currentValueVisible = false;

                options.forEach(option => {
                    const ownerId = option.getAttribute('data-owner-id');

                    if (checkbox.checked) {
                        // –ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ –∑–∞—è–≤–∫–∏
                        option.style.display = '';
                        if (option.value === currentValue) {
                            currentValueVisible = true;
                        }
                        } else {
                            // –ü–æ–∫–∞–∑–∞—Ç—å —Ç–æ–ª—å–∫–æ —Å–≤–æ–∏ –∑–∞—è–≤–∫–∏
                            if (ownerId && parseInt(ownerId) === currentUserId) {
                                option.style.display = '';
                            } else {
                                option.style.display = 'none';
                            }
                        }
                });

                // –ï—Å–ª–∏ —Ç–µ–∫—É—â–µ–µ –≤—ã–±—Ä–∞–Ω–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ —Å–∫—Ä—ã—Ç–æ, —Å–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—ã–±–æ—Ä
                if (!currentValueVisible && currentValue) {
                    select.value = '';
                    updateAllChunksOption(); // –û–±–Ω–æ–≤–ª—è–µ–º –æ–ø—Ü–∏—é "–í—Å–µ —á–∞–Ω–∫–∏"
                }
            }
            window.toggleApplicationsView = toggleApplicationsView;

            // –ü—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã —Å–∫—Ä—ã–≤–∞–µ–º —á—É–∂–∏–µ –∑–∞—è–≤–∫–∏ –¥–ª—è –∞–¥–º–∏–Ω–æ–≤ –∏ –ø—Ä–æ–º–ø—Ç-–∏–Ω–∂–µ–Ω–µ—Ä–æ–≤
            {% if current_user.is_admin() or current_user.is_prompt_engineer() %}
            toggleApplicationsView();
            {% endif %}
        });
    </script>

    <style>
        /* –°—Ç–∏–ª–∏ –¥–ª—è –∫–Ω–æ–ø–∫–∏ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ */
        .button-danger {
            background-color: #dc3545;
            color: white;
        }

        .button-danger:hover {
            background-color: #c82333;
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π */
        .alert {
            padding: 15px;
            margin-bottom: 20px;
            border: 1px solid transparent;
            border-radius: 4px;
        }

        .alert-warning {
            color: #856404;
            background-color: #fff3cd;
            border-color: #ffeaa7;
        }

        .alert-error {
            color: #721c24;
            background-color: #f8d7da;
            border-color: #f5c6cb;
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ø–æ–∏—Å–∫–∞ */
        .llm-result {
            margin-bottom: 20px;
        }

        .llm-value {
            font-size: 1.2rem;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 4px;
            border-left: 4px solid #007bff;
            margin-bottom: 10px;
        }

        .result-item {
            background-color: #f8f9fa;
            border-left: 4px solid #007bff;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 0 4px 4px 0;
        }

        .result-header {
            display: flex;
            margin-bottom: 10px;
        }

        .result-position {
            font-size: 1.2rem;
            font-weight: bold;
            margin-right: 15px;
            background-color: #007bff;
            color: white;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }

        .result-meta {
            display: flex;
            flex-direction: column;
        }

        .result-document, .result-page, .result-score, .result-score-rerank, .result-search-type {
            font-size: 0.9rem;
            color: #6c757d;
            margin-bottom: 3px;
        }

        .result-score-rerank {
            color: #28a745;
            font-weight: bold;
        }

        .result-search-type {
            font-weight: bold;
            display: inline-block;
            padding: 2px 6px;
            border-radius: 3px;
            margin-bottom: 5px;
        }

        .result-hybrid {
            background-color: #e6f3ff;
            color: #0066cc;
        }

        .result-text {
            background-color: #f0fff0;
            color: #006600;
        }

        .result-vector {
            background-color: #fff0f0;
            color: #cc0000;
        }

        .result-content {
            white-space: pre-line;
            font-family: monospace;
            background-color: white;
            padding: 10px;
            border-radius: 4px;
            border: 1px solid #dee2e6;
            max-height: 300px;
            overflow-y: auto;
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –æ—à–∏–±–æ–∫ */
        .error-container {
            margin: 20px 0;
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            border-radius: 8px;
            padding: 20px;
        }

        .error-message {
            color: #721c24;
        }

        .error-message h3 {
            margin-top: 0;
            margin-bottom: 10px;
        }

        .error-message button {
            margin-top: 10px;
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä–∞ –ø–æ–∏—Å–∫–∞ */
        .search-progress {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .progress {
            height: 20px;
            margin: 15px 0;
            background-color: #e9ecef;
            border-radius: 0.25rem;
            overflow: hidden;
        }

        .progress-bar {
            display: flex;
            flex-direction: column;
            justify-content: center;
            color: #fff;
            text-align: center;
            background-color: #007bff;
            transition: width .6s ease;
        }

        .progress-bar-striped {
            background-image: linear-gradient(45deg,rgba(255,255,255,.15) 25%,transparent 25%,transparent 50%,rgba(255,255,255,.15) 50%,rgba(255,255,255,.15) 75%,transparent 75%,transparent);
            background-size: 1rem 1rem;
        }

        .progress-bar-animated {
            animation: progress-bar-stripes 1s linear infinite;
        }

        @keyframes progress-bar-stripes {
            from { background-position: 1rem 0 }
            to { background-position: 0 0 }
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ø–æ–∏—Å–∫–∞ */
            margin-bottom: 10px;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 4px;
        }

        .no-results {
            padding: 20px;
            text-align: center;
            background-color: #f8f9fa;
            border-radius: 4px;
        }

        /* –°—Ç–∏–ª—å –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç–∏ */
        .confidence-bar {
            position: relative;
            height: 20px;
            background-color: #e9ecef;
            border-radius: 4px;
            overflow: hidden;
        }

        .confidence-value {
            position: absolute;
            top: 0;
            left: 0;
            height: 100%;
            background-color: #28a745;
            transition: width 0.3s ease;
        }

        .confidence-bar span {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            text-align: center;
            line-height: 20px;
            color: white;
            font-weight: bold;
            text-shadow: 0 0 2px rgba(0, 0, 0, 0.5);
            z-index: 1;
        }

            /* –°—Ç–∏–ª–∏ –¥–ª—è page-header —Å —á–µ–∫-–±–æ–∫—Å–æ–º */
    .page-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }

    .header-title {
        display: flex;
        align-items: center;
        gap: 20px;
    }

    .header-title h1 {
        margin: 0;
    }

    /* –°—Ç–∏–ª–∏ –¥–ª—è —á–µ–∫–±–æ–∫—Å–∞ */
    .checkbox-label {
        display: inline-flex;
        align-items: center;
        cursor: pointer;
        font-weight: 500;
        user-select: none;
        margin: 0;
    }

    .checkbox-label input[type="checkbox"] {
        margin-right: 8px;
        cursor: pointer;
    }

    .checkbox-label span {
        color: #495057;
        white-space: nowrap;
    }

    .checkbox-label:hover span {
        color: #007bff;
    }

    </style>
{% endblock %}