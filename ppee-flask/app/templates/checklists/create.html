<!-- app/templates/checklists/create.html -->
{% extends "base.html" %}

{% block content %}
    <div class="page-header">
        <h1>
            {% if original_checklist %}
                –°–æ–∑–¥–∞–Ω–∏–µ –∫–æ–ø–∏–∏ —á–µ–∫-–ª–∏—Å—Ç–∞
            {% else %}
                –°–æ–∑–¥–∞–Ω–∏–µ —á–µ–∫-–ª–∏—Å—Ç–∞
            {% endif %}
        </h1>
        <a href="{{ url_for('checklists.index') }}" class="button button-secondary">–ù–∞–∑–∞–¥ –∫ —Å–ø–∏—Å–∫—É</a>
    </div>
    
    <div class="form-container">
        {% if original_checklist %}
            <div class="info-card copy-info">
                <h3>–ö–æ–ø–∏—Ä—É–µ—Ç—Å—è –∏–∑ —á–µ–∫-–ª–∏—Å—Ç–∞: "{{ original_checklist.name }}"</h3>
                <p>–ü–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è: {{ original_checklist.parameters.count() }}</p>
            </div>
        {% endif %}
        
        <form method="post">
            {% if original_checklist %}
                <input type="hidden" name="original_checklist_id" value="{{ original_checklist.id }}">
            {% endif %}

            <div class="form-group">
                <label for="name">–ù–∞–∑–≤–∞–Ω–∏–µ —á–µ–∫-–ª–∏—Å—Ç–∞</label>
                <input type="text" 
                       id="name" 
                       name="name" 
                       value="{{ prefilled_name or '' }}" 
                       required
                       autofocus>
            </div>
            
            <div class="form-group">
                <label for="description">–û–ø–∏—Å–∞–Ω–∏–µ</label>
                <textarea id="description" 
                          name="description" 
                          rows="4">{{ prefilled_description or '' }}</textarea>
            </div>

            <div class="form-group">
                <label for="template_type">–¢–∏–ø —à–∞–±–ª–æ–Ω–∞</label>
                <select id="template_type" name="template_type">
                    <option value="support" {% if (original_checklist and original_checklist.template_type == 'support') or not original_checklist %}selected{% endif %}>üÜò –ü–æ–¥–¥–µ—Ä–∂–∫–∞</option>
                    <option value="analysis" {% if original_checklist and original_checklist.template_type == 'analysis' %}selected{% endif %}>üìä –ê–Ω–∞–ª–∏–∑</option>
                    <option value="qa" {% if original_checklist and original_checklist.template_type == 'qa' %}selected{% endif %}>‚ùì Q&A</option>
                    <option value="custom" {% if original_checklist and original_checklist.template_type == 'custom' %}selected{% endif %}>‚öôÔ∏è –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π</option>
                </select>
            </div>

            <div class="form-group">
                <label for="tags">–¢–µ–≥–∏ (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é)</label>
                <input type="text" 
                       id="tags" 
                       name="tags" 
                       placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä: —Ç–µ—Ö–ø–æ–¥–¥–µ—Ä–∂–∫–∞, –±–∞–∑–∞ –∑–Ω–∞–Ω–∏–π, FAQ"
                       value="{{ ','.join(original_checklist.tags) if original_checklist and original_checklist.tags else '' }}">
                <p class="form-note">–¢–µ–≥–∏ –ø–æ–º–æ–≥–∞—é—Ç –æ—Ä–≥–∞–Ω–∏–∑–æ–≤–∞—Ç—å –∏ –±—ã—Å—Ç—Ä–æ –Ω–∞—Ö–æ–¥–∏—Ç—å –Ω—É–∂–Ω—ã–µ —à–∞–±–ª–æ–Ω—ã.<br>
                <strong>–°–æ–≤–µ—Ç:</strong> –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ç–µ–≥ <code>llm:model_name</code> –¥–ª—è —É–∫–∞–∑–∞–Ω–∏—è –º–æ–¥–µ–ª–∏ LLM (–Ω–∞–ø—Ä–∏–º–µ—Ä: <code>llm:gemma3:27b</code>)</p>
            </div>

            <div class="form-group">
                <label for="prompt_text">–¢–µ–∫—Å—Ç –ø—Ä–æ–º–ø—Ç–∞ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
                <textarea id="prompt_text" 
                          name="prompt_text" 
                          rows="10"
                          placeholder="–û—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–≥–æ –ø—Ä–æ–º–ø—Ç–∞ –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Ç–∏–ø–∞">{{ original_checklist.prompt_text if original_checklist else '' }}</textarea>
                <p class="form-note">–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ <code>{query}</code> –∏ <code>{context}</code> –≤ —Ç–µ–∫—Å—Ç–µ –ø—Ä–æ–º–ø—Ç–∞</p>
            </div>

            <div class="form-group">
                <label for="response_format">–§–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
                <textarea id="response_format" 
                          name="response_format" 
                          rows="4"
                          placeholder="–û–ø–∏—à–∏—Ç–µ –∂–µ–ª–∞–µ–º—ã–π —Ñ–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞">{{ original_checklist.response_format if original_checklist else '' }}</textarea>
            </div>

            {% if current_user.is_admin() or current_user.is_prompt_engineer() or (original_checklist and original_checklist.user_id == current_user.id) %}
            <div class="form-group">
                <div class="checkbox-item">
                    <input type="checkbox" 
                           id="is_public" 
                           name="is_public"
                           {% if original_checklist and original_checklist.is_public %}checked{% endif %}>
                    <label for="is_public">
                        –û–±—â–∏–π –¥–æ—Å—Ç—É–ø (–¥—Ä—É–≥–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —Å–º–æ–≥—É—Ç –ø—Ä–æ—Å–º–∞—Ç—Ä–∏–≤–∞—Ç—å –∏ –∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —ç—Ç–æ—Ç —á–µ–∫-–ª–∏—Å—Ç)
                    </label>
                </div>
            </div>
            {% endif %}
            
            {% if original_checklist and original_checklist.parameters.count() > 0 %}
                <div class="form-group">
                    <div class="checkbox-item">
                        <input type="checkbox" 
                               id="copy_parameters" 
                               name="copy_parameters" 
                               value="true" 
                               checked>
                        <label for="copy_parameters">
                            –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã ({{ original_checklist.parameters.count() }} —à—Ç.)
                        </label>
                    </div>
                    <p class="form-note">–ï—Å–ª–∏ –≤—ã–±—Ä–∞–Ω–æ, –≤—Å–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –±—É–¥—É—Ç —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω—ã –≤ –Ω–æ–≤—ã–π —á–µ–∫-–ª–∏—Å—Ç</p>
                    
                    <div class="parameters-preview" id="parameters-preview">
                        <h4>–ü–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è:</h4>
                        <ul class="parameters-list">
                            {% for parameter in original_checklist.parameters %}
                                <li>
                                    <strong>{{ parameter.name }}</strong>
                                    <span class="parameter-details">
                                        ({{ parameter.llm_model }}, 
                                        {{ parameter.search_limit }} —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
                                        {% if parameter.use_reranker %}, —Ä–µ—Ä–µ–π—Ç–∏–Ω–≥{% endif %}
                                        {% if parameter.llm_query %}, <span class="llm-query-indicator">–æ—Ç–¥–µ–ª—å–Ω—ã–π LLM –∑–∞–ø—Ä–æ—Å</span>{% endif %})
                                    </span>
                                </li>
                            {% endfor %}
                        </ul>
                    </div>
                </div>
            {% endif %}

            <div class="form-actions">
                <button type="submit" class="button">
                    {% if original_checklist %}
                        –°–æ–∑–¥–∞—Ç—å –∫–æ–ø–∏—é
                    {% else %}
                        –°–æ–∑–¥–∞—Ç—å —á–µ–∫-–ª–∏—Å—Ç
                    {% endif %}
                </button>
                <a href="{{ url_for('checklists.index') }}" class="button button-secondary">–û—Ç–º–µ–Ω–∞</a>
            </div>
        </form>
    </div>

    <style>
        .copy-info {
            background-color: #e3f2fd;
            border-left: 4px solid #2196f3;
            margin-bottom: 20px;
        }

        .copy-info h3 {
            margin-top: 0;
            color: #1976d2;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }

        .checkbox-item input[type="checkbox"] {
            width: auto;
            margin-right: 10px;
        }

        .parameters-preview {
            margin-top: 15px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 4px;
            border: 1px solid #dee2e6;
        }

        .parameters-preview h4 {
            margin-top: 0;
            margin-bottom: 10px;
            color: #495057;
        }

        .parameters-list {
            list-style-type: none;
            padding: 0;
            margin: 0;
        }

        .parameters-list li {
            padding: 8px;
            margin-bottom: 5px;
            background-color: white;
            border-radius: 3px;
            border: 1px solid #e9ecef;
        }

        .parameter-details {
            color: #6c757d;
            font-size: 0.9em;
            margin-left: 5px;
        }

        .llm-query-indicator {
            color: #28a745;
            font-weight: bold;
        }
    </style>
    
    {% if original_checklist %}
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const nameInput = document.getElementById('name');
            const copyParametersCheckbox = document.getElementById('copy_parameters');
            const parametersPreview = document.getElementById('parameters-preview');
            
            // –í—ã–¥–µ–ª—è–µ–º —Ç–µ–∫—Å—Ç –≤ –ø–æ–ª–µ –∏–º–µ–Ω–∏
            nameInput.select();
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º/—Å–∫—Ä—ã–≤–∞–µ–º –ø—Ä–µ–≤—å—é –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
            if (copyParametersCheckbox && parametersPreview) {
                copyParametersCheckbox.addEventListener('change', function() {
                    parametersPreview.style.display = this.checked ? 'block' : 'none';
                });
            }
        });
    </script>
    {% endif %}
{% endblock %}