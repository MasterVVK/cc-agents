{% extends "base.html" %}

{% block title %}–ß–∞—Ç —Å {{ assistant.name }}{% endblock %}

{% block content %}
<div class="container-fluid mt-3">
    <div class="row">
        <!-- –û—Å–Ω–æ–≤–Ω–æ–π —á–∞—Ç -->
        <div class="col-md-8">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-robot"></i> {{ assistant.name }}
                        <small class="float-end">{{ assistant.assistant_type or 'support' }}</small>
                    </h5>
                </div>
                
                <div class="card-body chat-container" id="chatContainer" style="height: 500px; overflow-y: auto;">
                    <div id="messagesContainer">
                        {% for message in messages %}
                        <div class="message mb-3 {{ 'text-end' if message.role == 'user' else '' }}">
                            <div class="d-inline-block p-2 rounded {{ 'bg-primary text-white' if message.role == 'user' else 'bg-light' }}" 
                                 style="max-width: 70%;">
                                <small class="d-block mb-1">
                                    <strong>{{ '–í—ã' if message.role == 'user' else '–ü–æ–º–æ—â–Ω–∏–∫' }}</strong>
                                    - {{ message.created_at.strftime('%H:%M') }}
                                </small>
                                <div class="message-content">{{ message.content | safe }}</div>
                                {% if message.role == 'assistant' and message.processing_time %}
                                <small class="text-muted d-block mt-1">
                                    –í—Ä–µ–º—è –æ–±—Ä–∞–±–æ—Ç–∫–∏: {{ "%.2f"|format(message.processing_time) }} —Å–µ–∫
                                </small>
                                {% endif %}
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    
                    <div id="typingIndicator" class="mb-3" style="display: none;">
                        <div class="d-inline-block p-2 bg-light rounded typing-indicator">
                            <span id="typingText">–ü–æ–º–æ—â–Ω–∏–∫ –ø–µ—á–∞—Ç–∞–µ—Ç</span>
                            <span class="typing-dots">
                                <span class="typing-dot">.</span>
                                <span class="typing-dot">.</span>
                                <span class="typing-dot">.</span>
                            </span>
                        </div>
                    </div>
                </div>
                
                <div class="card-footer">
                    <form id="messageForm">
                        <div class="input-group">
                            <input type="text" 
                                   class="form-control" 
                                   id="messageInput" 
                                   placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à –≤–æ–ø—Ä–æ—Å..."
                                   autocomplete="off"
                                   required>
                            <button class="btn btn-primary" type="submit" id="sendButton">
                                <i class="fas fa-paper-plane"></i> –û—Ç–ø—Ä–∞–≤–∏—Ç—å
                            </button>
                            <button class="btn btn-outline-secondary" type="button" id="toggleTechBtn" title="–ü–æ–∫–∞–∑–∞—Ç—å/—Å–∫—Ä—ã—Ç—å —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏" style="margin-left:8px;">
                                üêû –î–µ—Ç–∞–ª–∏
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        
        <!-- –ë–æ–∫–æ–≤–∞—è –ø–∞–Ω–µ–ª—å -->
        <div class="col-md-4">
            <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–º–æ—â–Ω–∏–∫–µ -->
            <div class="card mb-3">
                <div class="card-header">
                    <h6 class="mb-0">–û –ø–æ–º–æ—â–Ω–∏–∫–µ</h6>
                </div>
                <div class="card-body">
                    <p>{{ assistant.description or '–ü–æ–º–æ—â–Ω–∏–∫ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∑–∞–ø—Ä–æ—Å–æ–≤' }}</p>
                    <small class="text-muted">
                        <strong>–ú–æ–¥–µ–ª—å:</strong> {{ assistant.llm_model or 'gemma3:27b' }}<br>
                        <strong>–ü–æ–∏—Å–∫:</strong> {{ '–í–∫–ª—é—á–µ–Ω' if assistant.enable_search else '–í—ã–∫–ª—é—á–µ–Ω' }}<br>
                        <strong>–õ–∏–º–∏—Ç –ø–æ–∏—Å–∫–∞:</strong> {{ assistant.search_limit }} –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤<br>
                        <strong>–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞:</strong> {{ assistant.temperature }}<br>
                    </small>
                </div>
            </div>
            
            <!-- –®–∞–±–ª–æ–Ω—ã –ø—Ä–æ–º–ø—Ç–æ–≤ -->
            {% if prompt_templates and not hide_template_select %}
            <div class="card mb-3">
                <div class="card-header">
                    <h6 class="mb-0">–®–∞–±–ª–æ–Ω—ã –ø—Ä–æ–º–ø—Ç–æ–≤</h6>
                </div>
                <div class="card-body">
                     <select class="form-select" id="templateSelect">
                         <option value="">–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –ø—Ä–æ–º–ø—Ç</option>
                         {% for template in prompt_templates %}
                         <option value="{{ template.id }}" {% if selected_template_id and selected_template_id == template.id %}selected{% endif %}>{{ template.name }}</option>
                         {% endfor %}
                     </select>
                    <small class="text-muted d-block mt-2">
                        –í—ã–±–µ—Ä–∏—Ç–µ —à–∞–±–ª–æ–Ω –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ç–∏–ª—è –æ—Ç–≤–µ—Ç–æ–≤
                    </small>
                </div>
            </div>
            {% endif %}
            
            <!-- –î–µ–π—Å—Ç–≤–∏—è -->
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0">–î–µ–π—Å—Ç–≤–∏—è</h6>
                </div>
                <div class="card-body">
                    <button class="btn btn-sm btn-outline-danger w-100 mb-2" type="button" onclick="clearChat()">
                        <i class="fas fa-trash"></i> –û—á–∏—Å—Ç–∏—Ç—å —á–∞—Ç
                    </button>
                    <a href="{{ url_for('chat.index') }}" class="btn btn-sm btn-outline-secondary w-100">
                        <i class="fas fa-arrow-left"></i> –ö —Å–ø–∏—Å–∫—É –ø–æ–º–æ—â–Ω–∏–∫–æ–≤
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- CSS –¥–ª—è –∞–Ω–∏–º–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞ -->
<style>
.typing-indicator {
    display: inline-flex;
    align-items: baseline;
    padding: 12px 16px !important;
}

.typing-dots {
    display: inline-flex;
    align-items: baseline;
    margin-left: 2px;
}

.typing-dot {
    display: inline-block;
    font-size: inherit;
    line-height: 1;
    font-weight: bold;
    color: #6c757d;
    animation: typing 1.4s infinite ease-in-out;
}

.typing-dot:nth-child(1) {
    animation-delay: 0s;
}

.typing-dot:nth-child(2) {
    animation-delay: 0.2s;
}

.typing-dot:nth-child(3) {
    animation-delay: 0.4s;
}

@keyframes typing {
    0%, 60%, 100% {
        transform: translateY(0);
        opacity: 0.3;
    }
    30% {
        transform: translateY(-5px);
        opacity: 1;
    }
}

#typingIndicator {
    transition: opacity 0.3s ease;
}

#typingIndicator.show {
    display: block !important;
    opacity: 1;
}

#typingIndicator.hide {
    opacity: 0;
}
</style>

<script>
console.log('[CHAT] conversation script loaded');
const conversationId = {{ conversation.id }};
const chatContainer = document.getElementById('chatContainer');
const messagesContainer = document.getElementById('messagesContainer');
const messageForm = document.getElementById('messageForm');
const messageInput = document.getElementById('messageInput');
const sendButton = document.getElementById('sendButton');
const typingIndicator = document.getElementById('typingIndicator');
const templateSelect = document.getElementById('templateSelect');

if (!messageForm || !messageInput || !messagesContainer) {
  console.error('[CHAT] Missing DOM elements', {messageForm, messageInput, messagesContainer});
}

window.addEventListener('error', (e) => {
  console.error('[CHAT] window error', e.error || e.message);
});

window.addEventListener('unhandledrejection', (e) => {
  console.error('[CHAT] unhandledrejection', e.reason);
});

// –ê–≤—Ç–æ—Å–∫—Ä–æ–ª–ª –≤–Ω–∏–∑
function scrollToBottom() {
    chatContainer.scrollTop = chatContainer.scrollHeight;
}

// –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ —á–∞—Ç
function addMessage(content, role, time = null) {
    const isUser = role === 'user';
    const messageDiv = document.createElement('div');
    messageDiv.className = `message mb-3 ${isUser ? 'text-end' : ''}`;
    
    const now = time || new Date().toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' });
    
    messageDiv.innerHTML = `
        <div class="d-inline-block p-2 rounded ${isUser ? 'bg-primary text-white' : 'bg-light'}" 
             style="max-width: 70%;">
            <small class="d-block mb-1">
                <strong>${isUser ? '–í—ã' : '–ü–æ–º–æ—â–Ω–∏–∫'}</strong> - ${now}
            </small>
            <div class="message-content">${content}</div>
        </div>
    `;
    
    messagesContainer.appendChild(messageDiv);
    // –†–µ–Ω–¥–µ—Ä–∏–º Markdown –≤ —Ç–æ–ª—å–∫–æ —á—Ç–æ –¥–æ–±–∞–≤–ª–µ–Ω–Ω–æ–º —Å–æ–æ–±—â–µ–Ω–∏–∏
    renderMarkdownIn(messageDiv.querySelector('.message-content'));
    scrollToBottom();
}
// –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ç–µ—Ö. –¥–µ—Ç–∞–ª–µ–π
const toggleBtn = document.getElementById('toggleTechBtn');
if (toggleBtn) {
  toggleBtn.addEventListener('click', () => {
    document.querySelectorAll('.tech-details').forEach(el => {
      el.style.display = (el.style.display === 'none' || !el.style.display) ? 'block' : 'none';
    });
  });
}

// –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ Markdown –≤–Ω—É—Ç—Ä–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ .message-content
function renderMarkdownIn(container) {
  if (!container) return;
  try {
    // –û—Ç–¥–µ–ª—è–µ–º –±–ª–æ–∫ —Ç–µ—Ö.–¥–µ—Ç–∞–ª–µ–π, —á—Ç–æ–±—ã –Ω–µ –ø–æ—Ä—Ç–∏—Ç—å –µ–≥–æ
    const tech = container.querySelector('.tech-details');
    const techHtml = tech ? tech.outerHTML : '';
    if (tech) tech.remove();

    const src = container.textContent; // —á–∏—Å—Ç—ã–π —Ç–µ–∫—Å—Ç
    // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ marked —Å –ø–æ–¥—Å–≤–µ—Ç–∫–æ–π –∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ–π –æ—á–∏—Å—Ç–∫–æ–π
    marked.setOptions({
      breaks: true,
      highlight: function(code, lang) {
        try { return hljs.highlight(code, {language: lang}).value; } catch(e) {
          try { return hljs.highlightAuto(code).value; } catch(e2) { return code; }
        }
      }
    });
    const rawHtml = marked.parse(src);
    const safeHtml = DOMPurify.sanitize(rawHtml, {USE_PROFILES: {html: true}});
    container.innerHTML = safeHtml + techHtml;
  } catch (e) {
    console.error('[CHAT] markdown render error', e);
  }
}

// –†–µ–Ω–¥–µ—Ä–∏–º Markdown –¥–ª—è —É–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
document.querySelectorAll('.message-content').forEach(renderMarkdownIn);

// –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
messageForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    console.log('[CHAT] submit fired');
    
    const message = messageInput.value.trim();
    if (!message) return;
    
    // –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    addMessage(message, 'user');
    
    // –û—á–∏—â–∞–µ–º –ø–æ–ª–µ –∏ –±–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É
    messageInput.value = '';
    sendButton.disabled = true;
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä
    typingIndicator.style.display = 'block';
    typingIndicator.classList.add('show');
    const typingText = document.getElementById('typingText');
    if (typingText) typingText.textContent = '–ü–æ–º–æ—â–Ω–∏–∫ –ø–µ—á–∞—Ç–∞–µ—Ç';
    
    let waiting = false;
    try {
        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
        const response = await fetch('/chat/api/send_message', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: JSON.stringify({
                conversation_id: conversationId,
                message: message,
                template_id: templateSelect ? templateSelect.value : null
            })
        });
        
        const data = await response.json();
        
        if (data.status === 'pending' && data.task_id) {
            // –ñ–¥–µ–º –æ—Ç–≤–µ—Ç
            waiting = true;
            await waitForResponse(data.task_id, data.message_id);
        } else if (data.status === 'success' && data.message) {
            // Eager-—Ä–µ–∂–∏–º: –æ—Ç–≤–µ—Ç —É–∂–µ –≥–æ—Ç–æ–≤
            addMessage(data.message, 'assistant');
        } else if (data.status === 'error') {
            addMessage(`–û—à–∏–±–∫–∞: ${data.message}`, 'assistant');
        }
        
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞:', error);
        addMessage('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Å–æ–æ–±—â–µ–Ω–∏—è', 'assistant');
    } finally {
        sendButton.disabled = false;
        if (!waiting) {
          // –°–∫—Ä—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä —Å –∞–Ω–∏–º–∞—Ü–∏–µ–π
          typingIndicator.classList.remove('show');
          typingIndicator.classList.add('hide');
          setTimeout(() => {
            typingIndicator.style.display = 'none';
            typingIndicator.classList.remove('hide');
          }, 300);
        }
    }
});

// –û–∂–∏–¥–∞–Ω–∏–µ –æ—Ç–≤–µ—Ç–∞ –æ—Ç –∑–∞–¥–∞—á–∏ ‚Äî –≤–æ–∑–≤—Ä–∞—â–∞–µ–º Promise, —á—Ç–æ–±—ã —Ä–µ–∞–ª—å–Ω–æ –∂–¥–∞—Ç—å –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è
function waitForResponse(taskId, messageId) {
    return new Promise((resolve) => {
        const maxAttempts = 120; // 120 —Å–µ–∫—É–Ω–¥ –º–∞–∫—Å–∏–º—É–º, —Ç.–∫. LLM –º–æ–∂–µ—Ç –æ—Ç–≤–µ—á–∞—Ç—å –¥–æ 60—Å
        let attempts = 0;

        const timer = setInterval(async () => {
            attempts++;

            try {
                const response = await fetch(`/chat/api/task_status/${taskId}?conversation_id=${conversationId}&message_id=${messageId || ''}`);
                const data = await response.json();

                if (data.status === 'progress') {
                    const typingText = document.getElementById('typingText');
                    if (typingText && data.message) {
                        // –£–±–∏—Ä–∞–µ–º —Ç–æ—á–∫–∏ –∏–∑ —Ç–µ–∫—Å—Ç–∞, –µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å
                        const cleanMessage = data.message.replace(/\.{3}$/, '');
                        typingText.textContent = cleanMessage;
                    }
                } else if (data.status === 'success') {
                    clearInterval(timer);
                    addMessage(data.message, 'assistant');
                    // –°–∫—Ä—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä
                    typingIndicator.classList.remove('show');
                    typingIndicator.classList.add('hide');
                    setTimeout(() => {
                        typingIndicator.style.display = 'none';
                        typingIndicator.classList.remove('hide');
                    }, 300);
                    return resolve('success');
                }

                if (data.status === 'error') {
                    clearInterval(timer);
                    addMessage(`–û—à–∏–±–∫–∞: ${data.message}`, 'assistant');
                    // –°–∫—Ä—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä
                    typingIndicator.classList.remove('show');
                    typingIndicator.classList.add('hide');
                    setTimeout(() => {
                        typingIndicator.style.display = 'none';
                        typingIndicator.classList.remove('hide');
                    }, 300);
                    return resolve('error');
                }

                if (attempts >= maxAttempts) {
                    clearInterval(timer);
                    addMessage('–ü—Ä–µ–≤—ã—à–µ–Ω–æ –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è –æ—Ç–≤–µ—Ç–∞', 'assistant');
                    // –°–∫—Ä—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä
                    typingIndicator.classList.remove('show');
                    typingIndicator.classList.add('hide');
                    setTimeout(() => {
                        typingIndicator.style.display = 'none';
                        typingIndicator.classList.remove('hide');
                    }, 300);
                    return resolve('timeout');
                }

            } catch (error) {
                clearInterval(timer);
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ç–∞—Ç—É—Å–∞:', error);
                addMessage('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –æ—Ç–≤–µ—Ç–∞', 'assistant');
                // –°–∫—Ä—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä
                typingIndicator.classList.remove('show');
                typingIndicator.classList.add('hide');
                setTimeout(() => {
                    typingIndicator.style.display = 'none';
                    typingIndicator.classList.remove('hide');
                }, 300);
                return resolve('network_error');
            }
        }, 1000);
    });
}

// –û—á–∏—Å—Ç–∫–∞ —á–∞—Ç–∞
async function clearChat() {
    if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—á–∏—Å—Ç–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é –¥–∏–∞–ª–æ–≥–∞?')) return;
    
    try {
        const response = await fetch(`/chat/api/conversation/${conversationId}/clear`, {
            method: 'POST'
        });
        
        const data = await response.json();
        
        if (data.status === 'success') {
            messagesContainer.innerHTML = '';
            alert('–ò—Å—Ç–æ—Ä–∏—è –¥–∏–∞–ª–æ–≥–∞ –æ—á–∏—â–µ–Ω–∞');
        } else {
            alert(`–û—à–∏–±–∫–∞: ${data.message}`);
        }
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞:', error);
        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—á–∏—Å—Ç–∫–µ –∏—Å—Ç–æ—Ä–∏–∏');
    }
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
scrollToBottom();
messageInput.focus();
</script>
{% endblock %}