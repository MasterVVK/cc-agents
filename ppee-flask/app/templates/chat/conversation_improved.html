{% extends "base.html" %}

{% block title %}–ß–∞—Ç —Å {{ assistant.name }}{% endblock %}

{% block head %}
{{ super() }}
<!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º —Å—Ç–∏–ª–∏ –¥–ª—è –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞ -->
<link rel="stylesheet" href="{{ url_for('static', filename='css/chat-typing-indicator.css') }}">
<!-- –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ: FontAwesome –¥–ª—è –∏–∫–æ–Ω–æ–∫ (–µ—Å–ª–∏ –Ω—É–∂–Ω—ã –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∏–∫–æ–Ω–∫–∏) -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
{% endblock %}

{% block content %}
<div class="container-fluid mt-3">
    <div class="row">
        <!-- –û—Å–Ω–æ–≤–Ω–æ–π —á–∞—Ç -->
        <div class="col-md-8">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-robot"></i> {{ assistant.name }}
                        <small class="float-end">{{ assistant.assistant_type or 'support' }}</small>
                    </h5>
                </div>
                
                <div class="card-body chat-container" id="chatContainer" style="height: calc(100vh - 300px); min-height: 400px; overflow-y: auto;">
                    <div id="messagesContainer">
                        {% for message in messages %}
                        <div class="message mb-3 {{ 'text-end' if message.role == 'user' else '' }}">
                            <div class="d-inline-block p-2 rounded {{ 'bg-primary text-white' if message.role == 'user' else 'bg-light' }}" 
                                 style="max-width: 70%;">
                                <small class="d-block mb-1">
                                    <strong>{{ '–í—ã' if message.role == 'user' else '–ü–æ–º–æ—â–Ω–∏–∫' }}</strong>
                                    - {{ message.created_at.strftime('%H:%M') }}
                                </small>
                                <div class="message-content">{{ message.content | safe }}</div>
                                {% if message.role == 'assistant' and message.processing_time %}
                                <small class="text-muted d-block mt-1">
                                    –í—Ä–µ–º—è –æ–±—Ä–∞–±–æ—Ç–∫–∏: {{ "%.2f"|format(message.processing_time) }} —Å–µ–∫
                                </small>
                                {% endif %}
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    
                    <!-- –£–ª—É—á—à–µ–Ω–Ω—ã–π –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –Ω–∞–±–æ—Ä–∞ -->
                    <div id="typingIndicator" class="typing-indicator-wrapper hidden">
                        <div class="typing-indicator">
                            <div class="typing-indicator-avatar">ü§ñ</div>
                            <div class="typing-dots">
                                <div class="typing-dot"></div>
                                <div class="typing-dot"></div>
                                <div class="typing-dot"></div>
                            </div>
                            <span class="typing-text" id="typingText">–ü–æ–º–æ—â–Ω–∏–∫ –ø–µ—á–∞—Ç–∞–µ—Ç</span>
                        </div>
                    </div>
                </div>
                
                <div class="card-footer">
                    <form id="messageForm">
                        <div class="input-group">
                            <input type="text" 
                                   class="form-control" 
                                   id="messageInput" 
                                   placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à –≤–æ–ø—Ä–æ—Å... (Ctrl+Enter –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏)"
                                   autocomplete="off"
                                   required>
                            <button class="btn btn-primary" type="submit" id="sendButton">
                                <i class="fas fa-paper-plane"></i> –û—Ç–ø—Ä–∞–≤–∏—Ç—å
                            </button>
                            <button class="btn btn-outline-secondary" type="button" id="toggleTechBtn" title="–ü–æ–∫–∞–∑–∞—Ç—å/—Å–∫—Ä—ã—Ç—å —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏" style="margin-left:8px;">
                                üêû –î–µ—Ç–∞–ª–∏
                            </button>
                        </div>
                        <small class="text-muted mt-1 d-block">–ù–∞–∂–º–∏—Ç–µ Ctrl+Enter –¥–ª—è –±—ã—Å—Ç—Ä–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏</small>
                    </form>
                </div>
            </div>
        </div>
        
        <!-- –ë–æ–∫–æ–≤–∞—è –ø–∞–Ω–µ–ª—å -->
        <div class="col-md-4">
            <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–º–æ—â–Ω–∏–∫–µ -->
            <div class="card mb-3">
                <div class="card-header">
                    <h6 class="mb-0">–û –ø–æ–º–æ—â–Ω–∏–∫–µ</h6>
                </div>
                <div class="card-body">
                    <p>{{ assistant.description or '–ü–æ–º–æ—â–Ω–∏–∫ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∑–∞–ø—Ä–æ—Å–æ–≤' }}</p>
                    <small class="text-muted">
                        <strong>–ú–æ–¥–µ–ª—å:</strong> {{ resolved_llm_model or assistant.llm_model or 'gemma3:27b' }}<br>
                        <strong>–ü–æ–∏—Å–∫:</strong> {{ '–í–∫–ª—é—á–µ–Ω' if assistant.enable_search else '–í—ã–∫–ª—é—á–µ–Ω' }}<br>
                        <strong>–õ–∏–º–∏—Ç –ø–æ–∏—Å–∫–∞:</strong> {{ assistant.search_limit }} –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤<br>
                        <strong>–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞:</strong> {{ assistant.temperature }}<br>
                    </small>
                </div>
            </div>
            
            <!-- –®–∞–±–ª–æ–Ω—ã –ø—Ä–æ–º–ø—Ç–æ–≤ -->
            {% if prompt_templates and not hide_template_select %}
            <div class="card mb-3">
                <div class="card-header">
                    <h6 class="mb-0">–®–∞–±–ª–æ–Ω—ã –ø—Ä–æ–º–ø—Ç–æ–≤</h6>
                </div>
                <div class="card-body">
                     <select class="form-select" id="templateSelect">
                         <option value="">–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –ø—Ä–æ–º–ø—Ç</option>
                         {% for template in prompt_templates %}
                         <option value="{{ template.id }}" {% if selected_template_id and selected_template_id == template.id %}selected{% endif %}>{{ template.name }}</option>
                         {% endfor %}
                     </select>
                    <small class="text-muted d-block mt-2">
                        –í—ã–±–µ—Ä–∏—Ç–µ —à–∞–±–ª–æ–Ω –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ç–∏–ª—è –æ—Ç–≤–µ—Ç–æ–≤
                    </small>
                </div>
            </div>
            {% endif %}
            
            <!-- –î–µ–π—Å—Ç–≤–∏—è -->
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0">–î–µ–π—Å—Ç–≤–∏—è</h6>
                </div>
                <div class="card-body">
                    <button class="btn btn-sm btn-outline-danger w-100 mb-2" type="button" onclick="clearChat()">
                        <i class="fas fa-trash"></i> –û—á–∏—Å—Ç–∏—Ç—å —á–∞—Ç
                    </button>
                    <a href="{{ url_for('chat.index') }}" class="btn btn-sm btn-outline-secondary w-100">
                        <i class="fas fa-arrow-left"></i> –ö —Å–ø–∏—Å–∫—É –ø–æ–º–æ—â–Ω–∏–∫–æ–≤
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ –¥–ª—è markdown –∏ –ø–æ–¥—Å–≤–µ—Ç–∫–∏ –∫–æ–¥–∞ -->
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.5/dist/purify.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css">

<script>
console.log('[CHAT] conversation script loaded');
const conversationId = {{ conversation.id }};
const chatContainer = document.getElementById('chatContainer');
const messagesContainer = document.getElementById('messagesContainer');
const messageForm = document.getElementById('messageForm');
const messageInput = document.getElementById('messageInput');
const sendButton = document.getElementById('sendButton');
const typingIndicator = document.getElementById('typingIndicator');
const typingText = document.getElementById('typingText');
const templateSelect = document.getElementById('templateSelect');

// –ö–ª–∞—Å—Å –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–º –Ω–∞–±–æ—Ä–∞
class TypingIndicator {
    constructor(element, textElement) {
        this.element = element;
        this.textElement = textElement;
        this.indicator = element.querySelector('.typing-indicator');
        this.isVisible = false;
        this.hideTimeout = null;
    }
    
    show(text = '–ü–æ–º–æ—â–Ω–∏–∫ –ø–µ—á–∞—Ç–∞–µ—Ç', state = 'typing') {
        // –û—á–∏—â–∞–µ–º —Ç–∞–π–º–∞—É—Ç —Å–∫—Ä—ã—Ç–∏—è –µ—Å–ª–∏ –µ—Å—Ç—å
        if (this.hideTimeout) {
            clearTimeout(this.hideTimeout);
            this.hideTimeout = null;
        }
        
        // –£–¥–∞–ª—è–µ–º –≤—Å–µ –∫–ª–∞—Å—Å—ã —Å–æ—Å—Ç–æ—è–Ω–∏–π
        this.indicator.classList.remove('thinking', 'searching', 'error', 'minimal', 'pulse');
        
        // –î–æ–±–∞–≤–ª—è–µ–º –Ω—É–∂–Ω—ã–π –∫–ª–∞—Å—Å —Å–æ—Å—Ç–æ—è–Ω–∏—è
        if (state === 'thinking') {
            this.indicator.classList.add('thinking');
            text = text || '–ü–æ–º–æ—â–Ω–∏–∫ –¥—É–º–∞–µ—Ç';
        } else if (state === 'searching') {
            this.indicator.classList.add('searching');
            text = text || '–ò—â—É –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é';
        } else if (state === 'error') {
            this.indicator.classList.add('error');
            text = text || '–û—à–∏–±–∫–∞';
        } else if (state === 'generating') {
            this.indicator.classList.add('pulse');
            text = text || '–ì–µ–Ω–µ—Ä–∏—Ä—É—é –æ—Ç–≤–µ—Ç';
        }
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç
        this.textElement.textContent = text;
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä
        this.element.classList.remove('hidden');
        this.isVisible = true;
    }
    
    hide(delay = 0) {
        if (delay > 0) {
            this.hideTimeout = setTimeout(() => {
                this.element.classList.add('hidden');
                this.isVisible = false;
            }, delay);
        } else {
            this.element.classList.add('hidden');
            this.isVisible = false;
        }
    }
    
    updateText(text) {
        if (this.textElement) {
            this.textElement.textContent = text;
        }
    }
}

// –°–æ–∑–¥–∞–µ–º —ç–∫–∑–µ–º–ø–ª—è—Ä —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–º
const typingIndicatorManager = new TypingIndicator(typingIndicator, typingText);

// –ü—Ä–æ–≤–µ—Ä–∫–∞ —ç–ª–µ–º–µ–Ω—Ç–æ–≤
if (!messageForm || !messageInput || !messagesContainer) {
    console.error('[CHAT] Missing DOM elements', {messageForm, messageInput, messagesContainer});
}

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
window.addEventListener('error', (e) => {
    console.error('[CHAT] window error', e.error || e.message);
});

window.addEventListener('unhandledrejection', (e) => {
    console.error('[CHAT] unhandledrejection', e.reason);
});

// –ê–≤—Ç–æ—Å–∫—Ä–æ–ª–ª –≤–Ω–∏–∑
function scrollToBottom() {
    chatContainer.scrollTop = chatContainer.scrollHeight;
}

// –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ —á–∞—Ç
function addMessage(content, role, time = null) {
    const isUser = role === 'user';
    const messageDiv = document.createElement('div');
    messageDiv.className = `message mb-3 ${isUser ? 'text-end' : ''}`;
    
    const now = time || new Date().toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' });
    
    messageDiv.innerHTML = `
        <div class="d-inline-block p-2 rounded ${isUser ? 'bg-primary text-white' : 'bg-light'}" 
             style="max-width: 70%;">
            <small class="d-block mb-1">
                <strong>${isUser ? '–í—ã' : '–ü–æ–º–æ—â–Ω–∏–∫'}</strong> - ${now}
            </small>
            <div class="message-content">${content}</div>
        </div>
    `;
    
    messagesContainer.appendChild(messageDiv);
    // –†–µ–Ω–¥–µ—Ä–∏–º Markdown –≤ —Ç–æ–ª—å–∫–æ —á—Ç–æ –¥–æ–±–∞–≤–ª–µ–Ω–Ω–æ–º —Å–æ–æ–±—â–µ–Ω–∏–∏
    renderMarkdownIn(messageDiv.querySelector('.message-content'));
    scrollToBottom();
}

// –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏—Ö –¥–µ—Ç–∞–ª–µ–π
const toggleBtn = document.getElementById('toggleTechBtn');
if (toggleBtn) {
    toggleBtn.addEventListener('click', () => {
        document.querySelectorAll('.tech-details').forEach(el => {
            el.style.display = (el.style.display === 'none' || !el.style.display) ? 'block' : 'none';
        });
    });
}

// –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ Markdown
function renderMarkdownIn(container) {
    if (!container) return;
    try {
        // –û—Ç–¥–µ–ª—è–µ–º –±–ª–æ–∫ —Ç–µ—Ö.–¥–µ—Ç–∞–ª–µ–π
        const tech = container.querySelector('.tech-details');
        const techHtml = tech ? tech.outerHTML : '';
        if (tech) tech.remove();

        const src = container.textContent;
        // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ marked —Å –ø–æ–¥—Å–≤–µ—Ç–∫–æ–π
        marked.setOptions({
            breaks: true,
            highlight: function(code, lang) {
                try { 
                    return hljs.highlight(code, {language: lang}).value; 
                } catch(e) {
                    try { 
                        return hljs.highlightAuto(code).value; 
                    } catch(e2) { 
                        return code; 
                    }
                }
            }
        });
        const rawHtml = marked.parse(src);
        const safeHtml = DOMPurify.sanitize(rawHtml, {USE_PROFILES: {html: true}});
        container.innerHTML = safeHtml + techHtml;
        
        // –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫–∏ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è –∫ –±–ª–æ–∫–∞–º –∫–æ–¥–∞
        container.querySelectorAll('pre code').forEach(block => {
            const pre = block.parentElement;
            const wrapper = document.createElement('div');
            wrapper.className = 'code-block-wrapper';
            wrapper.style.position = 'relative';
            
            const copyBtn = document.createElement('button');
            copyBtn.className = 'btn btn-sm btn-outline-secondary copy-code-btn';
            copyBtn.innerHTML = '<i class="fas fa-copy"></i> –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å';
            copyBtn.style.position = 'absolute';
            copyBtn.style.top = '5px';
            copyBtn.style.right = '5px';
            copyBtn.style.fontSize = '12px';
            copyBtn.onclick = async () => {
                try {
                    await navigator.clipboard.writeText(block.textContent);
                    copyBtn.innerHTML = '<i class="fas fa-check"></i> –°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!';
                    setTimeout(() => {
                        copyBtn.innerHTML = '<i class="fas fa-copy"></i> –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å';
                    }, 2000);
                } catch (err) {
                    console.error('Failed to copy:', err);
                }
            };
            
            pre.parentNode.insertBefore(wrapper, pre);
            wrapper.appendChild(pre);
            wrapper.appendChild(copyBtn);
        });
    } catch (e) {
        console.error('[CHAT] markdown render error', e);
    }
}

// –†–µ–Ω–¥–µ—Ä–∏–º Markdown –¥–ª—è —É–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
document.querySelectorAll('.message-content').forEach(renderMarkdownIn);

// –ì–æ—Ä—è—á–∏–µ –∫–ª–∞–≤–∏—à–∏ - Ctrl+Enter –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏
messageInput.addEventListener('keydown', (e) => {
    if (e.ctrlKey && e.key === 'Enter') {
        e.preventDefault();
        messageForm.dispatchEvent(new Event('submit'));
    }
});

// –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
messageForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    console.log('[CHAT] submit fired');
    
    const message = messageInput.value.trim();
    if (!message) return;
    
    // –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    addMessage(message, 'user');
    
    // –û—á–∏—â–∞–µ–º –ø–æ–ª–µ –∏ –±–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É
    messageInput.value = '';
    sendButton.disabled = true;
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä —Å –∞–Ω–∏–º–∞—Ü–∏–µ–π
    typingIndicatorManager.show('–û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è...', 'typing');
    
    let waiting = false;
    try {
        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
        const response = await fetch('/chat/api/send_message', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: JSON.stringify({
                conversation_id: conversationId,
                message: message,
                template_id: templateSelect ? templateSelect.value : null
            })
        });
        
        const data = await response.json();
        
        if (data.status === 'pending' && data.task_id) {
            // –ñ–¥–µ–º –æ—Ç–≤–µ—Ç
            waiting = true;
            typingIndicatorManager.show('–ü–æ–º–æ—â–Ω–∏–∫ –¥—É–º–∞–µ—Ç...', 'thinking');
            await waitForResponse(data.task_id, data.message_id);
        } else if (data.status === 'success' && data.message) {
            // Eager-—Ä–µ–∂–∏–º: –æ—Ç–≤–µ—Ç —É–∂–µ –≥–æ—Ç–æ–≤
            addMessage(data.message, 'assistant');
            typingIndicatorManager.hide(300);
        } else if (data.status === 'error') {
            addMessage(`–û—à–∏–±–∫–∞: ${data.message}`, 'assistant');
            typingIndicatorManager.show('–û—à–∏–±–∫–∞', 'error');
            typingIndicatorManager.hide(3000);
        }
        
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞:', error);
        addMessage('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Å–æ–æ–±—â–µ–Ω–∏—è', 'assistant');
        typingIndicatorManager.show('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è', 'error');
        typingIndicatorManager.hide(3000);
    } finally {
        sendButton.disabled = false;
        messageInput.focus();
        if (!waiting) {
            typingIndicatorManager.hide(300);
        }
    }
});

// –û–∂–∏–¥–∞–Ω–∏–µ –æ—Ç–≤–µ—Ç–∞ –æ—Ç –∑–∞–¥–∞—á–∏
function waitForResponse(taskId, messageId) {
    return new Promise((resolve) => {
        const maxAttempts = 120;
        let attempts = 0;
        let currentState = 'thinking';

        const timer = setInterval(async () => {
            attempts++;

            try {
                const response = await fetch(`/chat/api/task_status/${taskId}?conversation_id=${conversationId}&message_id=${messageId || ''}`);
                const data = await response.json();

                if (data.status === 'progress') {
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
                    if (data.message) {
                        if (data.message.includes('–ø–æ–∏—Å–∫') || data.message.includes('–ü–æ–∏—Å–∫')) {
                            typingIndicatorManager.show(data.message, 'searching');
                            currentState = 'searching';
                        } else if (data.message.includes('–≥–µ–Ω–µ—Ä') || data.message.includes('–ì–µ–Ω–µ—Ä')) {
                            typingIndicatorManager.show(data.message, 'generating');
                            currentState = 'generating';
                        } else {
                            typingIndicatorManager.show(data.message, currentState);
                        }
                    }
                } else if (data.status === 'success') {
                    clearInterval(timer);
                    addMessage(data.message, 'assistant');
                    typingIndicatorManager.hide(300);
                    return resolve('success');
                } else if (data.status === 'error') {
                    clearInterval(timer);
                    addMessage(`–û—à–∏–±–∫–∞: ${data.message}`, 'assistant');
                    typingIndicatorManager.show('–û—à–∏–±–∫–∞', 'error');
                    typingIndicatorManager.hide(3000);
                    return resolve('error');
                }

                if (attempts >= maxAttempts) {
                    clearInterval(timer);
                    addMessage('–ü—Ä–µ–≤—ã—à–µ–Ω–æ –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è –æ—Ç–≤–µ—Ç–∞', 'assistant');
                    typingIndicatorManager.show('–ü—Ä–µ–≤—ã—à–µ–Ω–æ –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è', 'error');
                    typingIndicatorManager.hide(3000);
                    return resolve('timeout');
                }

            } catch (error) {
                clearInterval(timer);
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ç–∞—Ç—É—Å–∞:', error);
                addMessage('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –æ—Ç–≤–µ—Ç–∞', 'assistant');
                typingIndicatorManager.show('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏', 'error');
                typingIndicatorManager.hide(3000);
                return resolve('network_error');
            }
        }, 1000);
    });
}

// –û—á–∏—Å—Ç–∫–∞ —á–∞—Ç–∞
async function clearChat() {
    if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—á–∏—Å—Ç–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é –¥–∏–∞–ª–æ–≥–∞?')) return;
    
    try {
        const response = await fetch(`/chat/api/conversation/${conversationId}/clear`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            }
        });
        
        const data = await response.json();
        
        if (data.status === 'success') {
            messagesContainer.innerHTML = '';
            alert('–ò—Å—Ç–æ—Ä–∏—è –¥–∏–∞–ª–æ–≥–∞ –æ—á–∏—â–µ–Ω–∞');
        } else {
            alert(`–û—à–∏–±–∫–∞: ${data.message}`);
        }
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞:', error);
        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—á–∏—Å—Ç–∫–µ –∏—Å—Ç–æ—Ä–∏–∏');
    }
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
scrollToBottom();
messageInput.focus();

// –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç–∏–ª–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è –ø—Ä—è–º–æ –≤ —Å—Ç—Ä–∞–Ω–∏—Ü—É
const style = document.createElement('style');
style.textContent = `
    .code-block-wrapper {
        position: relative;
        margin: 10px 0;
    }
    
    .copy-code-btn {
        opacity: 0;
        transition: opacity 0.2s;
    }
    
    .code-block-wrapper:hover .copy-code-btn {
        opacity: 1;
    }
    
    pre {
        padding-top: 35px !important;
    }
`;
document.head.appendChild(style);
</script>
{% endblock %}